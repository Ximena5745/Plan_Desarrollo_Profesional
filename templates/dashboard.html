<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Desarrollo Profesional</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet">
    
    <!-- Alpine.js para interactividad -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Animaciones personalizadas */
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        /* Kanban drag styles */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .drag-over {
            border: 2px dashed #6366f1;
            background-color: #eef2ff;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-base-200" x-data="appData()" x-init="init()">
    
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost text-xl">
                <i class="fas fa-chart-line text-primary"></i>
                Plan de Desarrollo
            </a>
        </div>
        
        <!-- Navigation Menu -->
        <div class="flex-none hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                <li><a @click="currentView = 'dashboard'" :class="currentView === 'dashboard' ? 'active' : ''">
                    <i class="fas fa-home"></i> Dashboard
                </a></li>
                <li><a @click="currentView = 'tasks'" :class="currentView === 'tasks' ? 'active' : ''">
                    <i class="fas fa-tasks"></i> Tareas
                </a></li>
                <li><a @click="currentView = 'monthly'" :class="currentView === 'monthly' ? 'active' : ''">
                    <i class="fas fa-calendar-alt"></i> Plan Mensual
                </a></li>
                <li><a @click="currentView = 'weekly'" :class="currentView === 'weekly' ? 'active' : ''">
                    <i class="fas fa-book"></i> Bit√°cora Semanal
                </a></li>
                <li><a @click="currentView = 'financial'" :class="currentView === 'financial' ? 'active' : ''">
                    <i class="fas fa-dollar-sign"></i> Control Financiero
                </a></li>
            </ul>
        </div>
        
        <!-- User Menu -->
        <div class="flex-none gap-2">
            <!-- Theme Toggle -->
            <label class="swap swap-rotate">
                <input type="checkbox" @change="toggleTheme" />
                <i class="fas fa-sun swap-on text-2xl"></i>
                <i class="fas fa-moon swap-off text-2xl"></i>
            </label>
            
            <!-- User Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-full w-10">
                        <span x-text="userInitials"></span>
                    </div>
                </div>
                <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li><a><i class="fas fa-user"></i> Perfil</a></li>
                    <li><a><i class="fas fa-cog"></i> Configuraci√≥n</a></li>
                    <li><a @click="logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a></li>
                </ul>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div class="drawer drawer-end lg:hidden">
            <input id="mobile-drawer" type="checkbox" class="drawer-toggle" />
            <div class="drawer-content">
                <label for="mobile-drawer" class="btn btn-square btn-ghost">
                    <i class="fas fa-bars text-xl"></i>
                </label>
            </div>
            <div class="drawer-side z-50">
                <label for="mobile-drawer" class="drawer-overlay"></label>
                <ul class="menu p-4 w-80 min-h-full bg-base-100">
                    <li><a @click="currentView = 'dashboard'"><i class="fas fa-home"></i> Dashboard</a></li>
                    <li><a @click="currentView = 'tasks'"><i class="fas fa-tasks"></i> Tareas</a></li>
                    <li><a @click="currentView = 'monthly'"><i class="fas fa-calendar-alt"></i> Plan Mensual</a></li>
                    <li><a @click="currentView = 'weekly'"><i class="fas fa-book"></i> Bit√°cora Semanal</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="container mx-auto p-4 mt-4">
        
        <!-- DASHBOARD VIEW -->
        <div x-show="currentView === 'dashboard'" class="slide-in">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                <!-- Stat Cards -->
                <div class="stat bg-base-100 shadow-lg rounded-box">
                    <div class="stat-figure text-primary">
                        <i class="fas fa-tasks text-3xl"></i>
                    </div>
                    <div class="stat-title">Total Tareas</div>
                    <div class="stat-value text-primary" x-text="stats.totalTasks"></div>
                    <div class="stat-desc">Este mes</div>
                </div>
                
                <div class="stat bg-base-100 shadow-lg rounded-box">
                    <div class="stat-figure text-success">
                        <i class="fas fa-check-circle text-3xl"></i>
                    </div>
                    <div class="stat-title">Completadas</div>
                    <div class="stat-value text-success" x-text="stats.completedTasks"></div>
                    <div class="stat-desc" x-text="`${stats.completionRate}% completado`"></div>
                </div>
                
                <div class="stat bg-base-100 shadow-lg rounded-box">
                    <div class="stat-figure text-warning">
                        <i class="fas fa-clock text-3xl"></i>
                    </div>
                    <div class="stat-title">Pendientes</div>
                    <div class="stat-value text-warning" x-text="stats.pendingTasks"></div>
                    <div class="stat-desc">Por hacer</div>
                </div>
                
                <div class="stat bg-base-100 shadow-lg rounded-box">
                    <div class="stat-figure text-info">
                        <i class="fas fa-book text-3xl"></i>
                    </div>
                    <div class="stat-title">Bit√°coras</div>
                    <div class="stat-value text-info" x-text="stats.weeklyLogsCount"></div>
                    <div class="stat-desc">Semanales</div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-chart-line text-primary"></i> Progreso Semanal</h2>
                        <div class="relative" style="height: 300px;">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-chart-pie text-secondary"></i> Tareas por Categor√≠a</h2>
                        <div class="relative" style="height: 300px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Tasks -->
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    <h2 class="card-title"><i class="fas fa-history text-accent"></i> Actividad Reciente</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>Tarea</th>
                                    <th>Categor√≠a</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="task in recentTasks" :key="task.id">
                                    <tr>
                                        <td x-text="task.titulo"></td>
                                        <td><span class="badge badge-outline" x-text="task.categoria"></span></td>
                                        <td><span class="badge" :class="getStatusBadgeClass(task.estado)" x-text="capitalize(task.estado)"></span></td>
                                        <td x-text="formatDate(task.fecha_inicio || task.fecha)"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TASKS VIEW -->
        <div x-show="currentView === 'tasks'" class="slide-in">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold"><i class="fas fa-tasks text-primary"></i> Gesti√≥n de Tareas</h1>
                <button class="btn btn-primary" @click="showNewTaskModal = true">
                    <i class="fas fa-plus"></i> Nueva Tarea
                </button>
            </div>
            
            <!-- View Toggle -->
            <div class="tabs tabs-boxed mb-4 bg-base-100 shadow">
                <a class="tab" :class="taskView === 'list' ? 'tab-active' : ''" @click="taskView = 'list'">
                    <i class="fas fa-list mr-2"></i> Lista
                </a>
                <a class="tab" :class="taskView === 'kanban' ? 'tab-active' : ''" @click="taskView = 'kanban'">
                    <i class="fas fa-columns mr-2"></i> Kanban
                </a>
            </div>
            
            <!-- List View -->
            <div x-show="taskView === 'list'">
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <!-- Info de tareas -->
                        <div class="alert alert-info mb-4" x-show="tasks.length === 0">
                            <i class="fas fa-info-circle"></i>
                            <span>No hay tareas creadas. Haz clic en "Nueva Tarea" para comenzar.</span>
                        </div>
                        <!-- Filtros de Tareas -->
                        <div class="card bg-base-200 p-4 mb-4" x-show="tasks.length > 0">
                            <div class="flex flex-wrap gap-3 items-end">
                                <div class="form-control flex-1 min-w-[150px]">
                                    <label class="label py-1">
                                        <span class="label-text text-xs font-semibold">Estado</span>
                                    </label>
                                    <select x-model="filterEstado" class="select select-bordered select-sm">
                                        <option value="">Todos</option>
                                        <option value="pendiente">Pendiente</option>
                                        <option value="en_progreso">En Progreso</option>
                                        <option value="completada">Completada</option>
                                        <option value="cancelada">Cancelada</option>
                                    </select>
                                </div>

                                <div class="form-control flex-1 min-w-[150px]">
                                    <label class="label py-1">
                                        <span class="label-text text-xs font-semibold">Prioridad</span>
                                    </label>
                                    <select x-model="filterPrioridad" class="select select-bordered select-sm">
                                        <option value="">Todas</option>
                                        <option value="alta">Alta</option>
                                        <option value="media">Media</option>
                                        <option value="baja">Baja</option>
                                    </select>
                                </div>

                                <div class="form-control flex-1 min-w-[150px]">
                                    <label class="label py-1">
                                        <span class="label-text text-xs font-semibold">Clasificaci√≥n</span>
                                    </label>
                                    <select x-model="filterClasificacion" class="select select-bordered select-sm">
                                        <option value="">Todas</option>
                                        <template x-for="clasificacion in uniqueClasificaciones" :key="clasificacion">
                                            <option :value="clasificacion" x-text="clasificacion"></option>
                                        </template>
                                    </select>
                                </div>

                                <div class="form-control flex-1 min-w-[150px]">
                                    <label class="label py-1">
                                        <span class="label-text text-xs font-semibold">Fecha</span>
                                    </label>
                                    <input type="date" x-model="filterFecha" class="input input-bordered input-sm" />
                                </div>

                                <button class="btn btn-sm btn-ghost gap-2"
                                        @click="clearFilters()"
                                        x-show="filterEstado || filterPrioridad || filterClasificacion || filterFecha">
                                    <i class="fas fa-times"></i>
                                    Limpiar Filtros
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4" x-show="tasks.length > 0">
                            <div class="alert alert-success text-sm flex-1 mr-2">
                                <i class="fas fa-tasks"></i>
                                <span>
                                    Mostrando <b x-text="filteredTasks.length"></b> de <b x-text="tasks.length"></b> tareas
                                    (<span x-text="filteredTasks.filter(t => !t.parent_task_id).length"></span> principales +
                                    <span x-text="filteredTasks.filter(t => t.parent_task_id).length"></span> subtareas)
                                </span>
                            </div>
                            <button class="btn btn-sm" @click="showSubtasks = !showSubtasks"
                                    :class="showSubtasks ? 'btn-primary' : 'btn-ghost'">
                                <i :class="showSubtasks ? 'fas fa-eye' : 'fas fa-eye-slash'"></i>
                                <span x-text="showSubtasks ? 'Ocultar Subtareas' : 'Mostrar Subtareas'"></span>
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="table table-compact">
                                <thead>
                                    <tr>
                                        <th>Tarea / Proyecto</th>
                                        <th>Clasificaci√≥n</th>
                                        <th>Progreso</th>
                                        <th>Estado</th>
                                        <th>Fechas</th>
                                        <th>Prioridad</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Mostrar todas las tareas con jerarqu√≠a visual -->
                                    <template x-for="task in filteredTasks" :key="task.id">
                                        <tr x-show="!task.parent_task_id || showSubtasks"
                                            :class="{'bg-base-200': task.es_macrotarea && !task.parent_task_id, 'hover': task.parent_task_id}">
                                            <td>
                                                <div class="flex items-center gap-2" :class="{'pl-8': task.parent_task_id}">
                                                    <!-- Icono de jerarqu√≠a para subtareas -->
                                                    <template x-if="task.parent_task_id">
                                                        <i class="fas fa-level-up-alt fa-rotate-90 text-xs opacity-40"></i>
                                                    </template>

                                                    <!-- Icono de tipo de tarea -->
                                                    <i :class="task.es_macrotarea ? 'fas fa-folder text-warning' : (task.parent_task_id ? 'fas fa-tasks text-info' : 'fas fa-check-circle text-success')" class="text-sm"></i>

                                                    <div>
                                                        <div :class="task.parent_task_id ? 'font-semibold text-sm' : 'font-bold'" x-text="task.titulo"></div>
                                                        <div :class="task.parent_task_id ? 'text-xs opacity-50' : 'text-xs opacity-60'" x-text="task.descripcion" x-show="task.descripcion"></div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-sm whitespace-normal text-left"
                                                      :class="task.parent_task_id ? 'badge-ghost' : 'badge-outline'"
                                                      :title="task.clasificacion"
                                                      x-text="task.clasificacion || 'N/A'"></span>
                                            </td>
                                            <td>
                                                <div class="flex items-center gap-2">
                                                    <progress class="progress" :class="task.parent_task_id ? 'progress-info w-12' : 'progress-primary w-16'" :value="task.progreso || 0" max="100"></progress>
                                                    <span class="text-xs font-mono" x-text="(task.progreso || 0) + '%'"></span>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-sm" :class="[getStatusBadgeClass(task.estado), task.parent_task_id ? 'opacity-70' : '']" x-text="capitalize(task.estado)"></span>
                                            </td>
                                            <td>
                                                <div class="text-xs">
                                                    <div x-show="task.fecha_inicio && task.fecha_fin">
                                                        <span x-text="formatDate(task.fecha_inicio)"></span> - <span x-text="formatDate(task.fecha_fin)"></span>
                                                    </div>
                                                    <div x-show="!task.fecha_inicio || !task.fecha_fin" class="text-gray-400">
                                                        Sin fechas
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge badge-sm" :class="[getPriorityBadgeClass(task.prioridad), task.parent_task_id ? 'opacity-70' : '']" x-text="capitalize(task.prioridad)"></span>
                                            </td>
                                            <td>
                                                <div class="flex gap-1">
                                                    <button class="btn btn-ghost btn-xs" @click="editTask(task)" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-ghost btn-xs text-error" @click="deleteTask(task.id)" title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kanban View -->
            <div x-show="taskView === 'kanban'">
                <!-- Filtros de Tareas -->
                <div class="card bg-base-200 p-4 mb-4" x-show="tasks.length > 0">
                    <div class="flex flex-wrap gap-3 items-center">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-filter text-sm opacity-70"></i>
                            <span class="text-xs font-semibold opacity-70">Filtros:</span>
                        </div>

                        <div class="form-control">
                            <select x-model="filterPrioridad" class="select select-bordered select-sm">
                                <option value="">Todas las Prioridades</option>
                                <option value="alta">Alta</option>
                                <option value="media">Media</option>
                                <option value="baja">Baja</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <select x-model="filterClasificacion" class="select select-bordered select-sm">
                                <option value="">Todas las Clasificaciones</option>
                                <template x-for="clasificacion in uniqueClasificaciones" :key="clasificacion">
                                    <option :value="clasificacion" x-text="clasificacion"></option>
                                </template>
                            </select>
                        </div>

                        <div class="form-control">
                            <input type="date" x-model="filterFecha" class="input input-bordered input-sm" placeholder="Filtrar por fecha" />
                        </div>

                        <button class="btn btn-sm btn-ghost gap-2"
                                @click="clearFilters()"
                                x-show="filterPrioridad || filterClasificacion || filterFecha">
                            <i class="fas fa-times"></i>
                            Limpiar
                        </button>
                    </div>
                </div>

                <!-- Kanban Columns Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Pendientes Column -->
                    <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <h3 class="card-title text-warning">
                            <i class="fas fa-clock"></i> Pendientes
                            <span class="badge badge-warning" x-text="getTasksByStatus('pendiente').length"></span>
                        </h3>
                        <div class="space-y-2 min-h-[400px]" 
                             @drop="handleDrop($event, 'pendiente')" 
                             @dragover.prevent 
                             @dragenter.prevent="$event.target.classList.add('drag-over')"
                             @dragleave="$event.target.classList.remove('drag-over')">
                            <template x-for="task in getTasksByStatus('pendiente')" :key="task.id">
                                <div class="card bg-base-200 shadow cursor-move"
                                     draggable="true"
                                     @dragstart="handleDragStart($event, task)"
                                     @dragend="handleDragEnd">
                                    <div class="card-body p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="font-bold flex-1" x-text="task.titulo"></h4>
                                            <div class="dropdown dropdown-end">
                                                <label tabindex="0" class="btn btn-ghost btn-xs">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </label>
                                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40">
                                                    <li><a @click="editTask(task)"><i class="fas fa-edit"></i> Editar</a></li>
                                                    <li><a @click="deleteTask(task.id)" class="text-error"><i class="fas fa-trash"></i> Eliminar</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <p class="text-sm opacity-70" x-text="task.descripcion"></p>
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="badge badge-sm" x-text="task.categoria"></span>
                                            <span class="badge badge-sm" :class="getPriorityBadgeClass(task.prioridad)" x-text="capitalize(task.prioridad)"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- En Progreso Column -->
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <h3 class="card-title text-info">
                            <i class="fas fa-spinner"></i> En Progreso
                            <span class="badge badge-info" x-text="getTasksByStatus('en_progreso').length"></span>
                        </h3>
                        <div class="space-y-2 min-h-[400px]"
                             @drop="handleDrop($event, 'en_progreso')" 
                             @dragover.prevent
                             @dragenter.prevent="$event.target.classList.add('drag-over')"
                             @dragleave="$event.target.classList.remove('drag-over')">
                            <template x-for="task in getTasksByStatus('en_progreso')" :key="task.id">
                                <div class="card bg-base-200 shadow cursor-move"
                                     draggable="true"
                                     @dragstart="handleDragStart($event, task)"
                                     @dragend="handleDragEnd">
                                    <div class="card-body p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="font-bold flex-1" x-text="task.titulo"></h4>
                                            <div class="dropdown dropdown-end">
                                                <label tabindex="0" class="btn btn-ghost btn-xs">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </label>
                                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40">
                                                    <li><a @click="editTask(task)"><i class="fas fa-edit"></i> Editar</a></li>
                                                    <li><a @click="deleteTask(task.id)" class="text-error"><i class="fas fa-trash"></i> Eliminar</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <p class="text-sm opacity-70" x-text="task.descripcion"></p>
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="badge badge-sm" x-text="task.categoria"></span>
                                            <span class="badge badge-sm" :class="getPriorityBadgeClass(task.prioridad)" x-text="capitalize(task.prioridad)"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Completadas Column -->
                <div class="card bg-base-100 shadow-lg">
                    <div class="card-body">
                        <h3 class="card-title text-success">
                            <i class="fas fa-check-circle"></i> Completadas
                            <span class="badge badge-success" x-text="getTasksByStatus('completada').length"></span>
                        </h3>
                        <div class="space-y-2 min-h-[400px]"
                             @drop="handleDrop($event, 'completada')" 
                             @dragover.prevent
                             @dragenter.prevent="$event.target.classList.add('drag-over')"
                             @dragleave="$event.target.classList.remove('drag-over')">
                            <template x-for="task in getTasksByStatus('completada')" :key="task.id">
                                <div class="card bg-base-200 shadow cursor-move"
                                     draggable="true"
                                     @dragstart="handleDragStart($event, task)"
                                     @dragend="handleDragEnd">
                                    <div class="card-body p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <h4 class="font-bold line-through flex-1" x-text="task.titulo"></h4>
                                            <div class="dropdown dropdown-end">
                                                <label tabindex="0" class="btn btn-ghost btn-xs">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </label>
                                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-40">
                                                    <li><a @click="editTask(task)"><i class="fas fa-edit"></i> Editar</a></li>
                                                    <li><a @click="deleteTask(task.id)" class="text-error"><i class="fas fa-trash"></i> Eliminar</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <p class="text-sm opacity-70" x-text="task.descripcion"></p>
                                        <div class="flex justify-between items-center mt-2">
                                            <span class="badge badge-sm" x-text="task.categoria"></span>
                                            <span class="text-xs text-success">‚úì Completada</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                </div><!-- Close grid -->
            </div><!-- Close kanban view -->
        </div>

        <!-- MONTHLY VIEW -->
        <div x-show="currentView === 'monthly'" class="slide-in">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold"><i class="fas fa-calendar-alt text-primary"></i> Plan Mensual</h1>
                <button class="btn btn-primary" @click="createNewPlan()">
                    <i class="fas fa-plus"></i> Nuevo Plan
                </button>
            </div>

            <!-- Selector de Plan Mensual -->
            <div class="card bg-base-100 shadow-lg mb-6" x-show="monthlyPlans.length > 0">
                <div class="card-body py-4">
                    <div class="flex items-center gap-4">
                        <label class="label">
                            <span class="label-text font-semibold">Seleccionar Plan:</span>
                        </label>
                        <select x-model="currentPlanId" @change="loadExistingPlan(currentPlanId)" class="select select-bordered flex-1">
                            <template x-for="plan in monthlyPlans" :key="plan.id">
                                <option :value="plan.id" x-text="formatMonth(plan.mes)"></option>
                            </template>
                        </select>
                        <div class="stats shadow" x-show="planComparison">
                            <div class="stat py-2 px-4">
                                <div class="stat-title text-xs">Competencias</div>
                                <div class="stat-value text-2xl" x-text="planComparison?.competencias_stats?.total || 0"></div>
                            </div>
                            <div class="stat py-2 px-4">
                                <div class="stat-title text-xs">Progreso Promedio</div>
                                <div class="stat-value text-2xl" x-text="Math.round(planComparison?.competencias_stats?.promedio_progreso_fin || 0) + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs de Secciones -->
            <div class="tabs tabs-boxed mb-4 bg-base-100 shadow">
                <a class="tab" :class="monthlyView === 'gestion' ? 'tab-active' : ''" @click="monthlyView = 'gestion'">
                    <i class="fas fa-edit mr-2"></i> Gesti√≥n
                </a>
                <a class="tab" :class="monthlyView === 'competencias' ? 'tab-active' : ''" @click="monthlyView = 'competencias'">
                    <i class="fas fa-chart-bar mr-2"></i> Competencias
                </a>
                <a class="tab" :class="monthlyView === 'analisis' ? 'tab-active' : ''" @click="monthlyView = 'analisis'">
                    <i class="fas fa-chart-line mr-2"></i> An√°lisis
                </a>
            </div>

            <!-- GESTI√ìN: Inicio y Fin de Mes -->
            <div x-show="monthlyView === 'gestion'">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Inicio de Mes -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-play-circle text-success"></i>
                                Inicio de Mes
                            </h2>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Mes</span>
                                </label>
                                <input type="month"
                                       x-model="monthlyPlan.mes"
                                       @change="checkMonthAvailability()"
                                       class="input input-bordered"
                                       :class="monthAlreadyExists ? 'input-error' : ''"
                                       :disabled="!isEditMode || (!isCreatingNewPlan && viewingPlanId)" />
                                <label class="label" x-show="monthAlreadyExists && isCreatingNewPlan">
                                    <span class="label-text-alt text-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        Ya existe un plan para este mes
                                    </span>
                                </label>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Competencias a Trabajar</span>
                                </label>
                                <textarea x-model="monthlyPlan.competencias_trabajar" class="textarea textarea-bordered" placeholder="Comunicaci√≥n, Liderazgo, etc." rows="3" :disabled="!isEditMode"></textarea>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">¬øQu√© quiero lograr?</span>
                                </label>
                                <textarea x-model="monthlyPlan.que_quiero_lograr" class="textarea textarea-bordered" placeholder="Mis objetivos del mes..." rows="4" :disabled="!isEditMode"></textarea>
                            </div>

                            <!-- Actividades para Lograrlo -->
                            <div class="card bg-base-200 p-4">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="label">
                                        <span class="label-text font-semibold"><i class="fas fa-list-check"></i> Actividades para Lograrlo</span>
                                        <span class="badge badge-sm ml-2" x-text="(monthlyPlan.actividades_lograr || []).length"></span>
                                    </label>
                                </div>

                                <!-- Input para agregar nueva actividad -->
                                <div class="flex gap-2 mb-3" x-show="isEditMode || isCreatingNewPlan">
                                    <input type="text"
                                           x-model="newActividadLograr"
                                           @keyup.enter="addActividadLograr()"
                                           class="input input-bordered input-sm flex-1"
                                           placeholder="Nueva actividad..." />
                                    <button type="button"
                                            class="btn btn-primary btn-sm"
                                            @click="addActividadLograr()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <!-- Lista de actividades -->
                                <div class="space-y-2">
                                    <template x-for="(actividad, index) in (monthlyPlan.actividades_lograr || [])" :key="index">
                                        <div class="flex items-start gap-2 bg-base-100 p-2 rounded">
                                            <input type="checkbox"
                                                   :checked="actividad.completada"
                                                   @change="toggleActividadLograr(index)"
                                                   :disabled="!isEditMode && !isCreatingNewPlan"
                                                   class="checkbox checkbox-sm checkbox-success mt-0.5" />
                                            <span class="flex-1 text-sm"
                                                  :class="actividad.completada ? 'line-through opacity-60' : ''"
                                                  x-text="actividad.texto"></span>
                                            <button type="button"
                                                    class="btn btn-ghost btn-xs text-error"
                                                    @click="removeActividadLograr(index)"
                                                    x-show="isEditMode || isCreatingNewPlan">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </template>
                                    <div x-show="!monthlyPlan.actividades_lograr || monthlyPlan.actividades_lograr.length === 0"
                                         class="text-center text-sm opacity-50 py-2">
                                        No hay actividades agregadas
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Mis Fortalezas üí™</span>
                                    </label>
                                    <textarea x-model="monthlyPlan.mis_fortalezas" class="textarea textarea-bordered" rows="3" :disabled="!isEditMode"></textarea>
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">Mis Debilidades üéØ</span>
                                    </label>
                                    <textarea x-model="monthlyPlan.mis_debilidades" class="textarea textarea-bordered" rows="3" :disabled="!isEditMode"></textarea>
                                </div>
                            </div>

                            <!-- Modo Visualizaci√≥n -->
                            <div class="flex gap-2 mt-4" x-show="!isEditMode && viewingPlanId">
                                <button class="btn btn-primary flex-1" @click="enableEditMode()">
                                    <i class="fas fa-edit"></i> Editar Plan
                                </button>
                            </div>

                            <!-- Modo Edici√≥n (plan existente) -->
                            <div class="flex gap-2 mt-4" x-show="isEditMode && !isCreatingNewPlan">
                                <button class="btn btn-primary flex-1" @click="updateMonthlyPlan()">
                                    <i class="fas fa-save"></i> Guardar Cambios
                                </button>
                                <button class="btn btn-ghost flex-1" @click="cancelEdit()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>

                            <!-- Modo Creaci√≥n -->
                            <button class="btn btn-primary mt-4 btn-block" @click="saveMonthlyPlan"
                                    x-show="isEditMode && isCreatingNewPlan">
                                <i class="fas fa-save"></i> Crear Plan
                            </button>
                        </div>
                    </div>

                    <!-- Fin de Mes -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h2 class="card-title">
                                <i class="fas fa-flag-checkered text-error"></i>
                                Fin de Mes - Evaluaci√≥n
                            </h2>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">¬øQu√© mejor√©? üìà</span>
                                </label>
                                <textarea x-model="monthlyReview.que_mejore" class="textarea textarea-bordered" placeholder="Mis logros..." rows="3" :disabled="!isEditMode"></textarea>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">¬øQu√© me falt√≥ mejorar? üîç</span>
                                </label>
                                <textarea x-model="monthlyReview.que_falta_mejorar" class="textarea textarea-bordered" rows="3" :disabled="!isEditMode"></textarea>
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Habilidades Desarrolladas ‚ú®</span>
                                </label>
                                <input type="text" x-model="monthlyReview.habilidades_desarrolladas" class="input input-bordered" placeholder="An√°lisis de datos, Presentaciones..." :disabled="!isEditMode" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Momento Memorable üì∏</span>
                                </label>
                                <textarea x-model="monthlyReview.momento_memorable" class="textarea textarea-bordered" rows="2" :disabled="!isEditMode"></textarea>
                            </div>
                            <button class="btn btn-secondary mt-4" @click="saveMonthlyReview" x-show="isEditMode">
                                <i class="fas fa-check"></i> Guardar Evaluaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPETENCIAS: Gesti√≥n de Competencias con Progreso -->
            <div x-show="monthlyView === 'competencias'">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Agregar Nueva Competencia -->
                    <div class="card bg-base-100 shadow-lg lg:col-span-1">
                        <div class="card-body">
                            <h3 class="card-title text-lg">
                                <i class="fas fa-plus-circle text-primary"></i>
                                Agregar Competencia
                            </h3>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Nombre</span>
                                </label>
                                <input type="text" x-model="newCompetencia.nombre" class="input input-bordered input-sm" placeholder="Ej: Liderazgo" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Progreso Inicial: <span x-text="newCompetencia.progreso_inicio"></span>%</span>
                                </label>
                                <input type="range" x-model.number="newCompetencia.progreso_inicio" min="0" max="100" class="range range-primary range-sm" />
                            </div>
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Notas</span>
                                </label>
                                <textarea x-model="newCompetencia.notas" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm mt-2" @click="addCompetencia">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Competencias -->
                    <div class="card bg-base-100 shadow-lg lg:col-span-2">
                        <div class="card-body">
                            <h3 class="card-title">
                                <i class="fas fa-list text-info"></i>
                                Competencias en Seguimiento
                                <span class="badge badge-primary" x-text="monthlyPlan.competencias.length"></span>
                            </h3>

                            <div x-show="monthlyPlan.competencias.length === 0" class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span>No hay competencias agregadas. Usa el formulario para agregar una.</span>
                            </div>

                            <div class="space-y-4">
                                <template x-for="(competencia, index) in monthlyPlan.competencias" :key="index">
                                    <div class="card bg-base-200 shadow">
                                        <div class="card-body p-4">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-bold" x-text="competencia.nombre"></h4>
                                                <button class="btn btn-ghost btn-xs text-error" @click="removeCompetencia(index)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>

                                            <!-- Progreso Inicio -->
                                            <div class="form-control">
                                                <label class="label py-1">
                                                    <span class="label-text text-xs">Inicio: <span x-text="competencia.progreso_inicio"></span>%</span>
                                                </label>
                                                <input type="range"
                                                       :value="competencia.progreso_inicio"
                                                       @input="updateCompetenciaProgress(index, 'progreso_inicio', parseInt($event.target.value))"
                                                       min="0" max="100"
                                                       class="range range-xs range-primary" />
                                            </div>

                                            <!-- Progreso Actual -->
                                            <div class="form-control">
                                                <label class="label py-1">
                                                    <span class="label-text text-xs">Actual: <span x-text="competencia.progreso_actual"></span>%</span>
                                                </label>
                                                <input type="range"
                                                       :value="competencia.progreso_actual"
                                                       @input="updateCompetenciaProgress(index, 'progreso_actual', parseInt($event.target.value))"
                                                       min="0" max="100"
                                                       class="range range-xs range-success" />
                                            </div>

                                            <!-- Progreso Fin -->
                                            <div class="form-control">
                                                <label class="label py-1">
                                                    <span class="label-text text-xs">Fin: <span x-text="competencia.progreso_fin || 'No definido'"></span><span x-show="competencia.progreso_fin">%</span></span>
                                                </label>
                                                <input type="range"
                                                       :value="competencia.progreso_fin || 0"
                                                       @input="updateCompetenciaProgress(index, 'progreso_fin', parseInt($event.target.value))"
                                                       min="0" max="100"
                                                       class="range range-xs range-secondary" />
                                            </div>

                                            <!-- Notas -->
                                            <div class="text-xs mt-2 opacity-70" x-show="competencia.notas">
                                                <i class="fas fa-sticky-note"></i>
                                                <span x-text="competencia.notas"></span>
                                            </div>

                                            <!-- Actividades Section -->
                                            <div class="mt-3 border-t pt-3">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-xs font-semibold">
                                                        <i class="fas fa-tasks"></i> Actividades
                                                        <span class="badge badge-sm" x-text="(competencia.actividades || []).length"></span>
                                                    </span>
                                                </div>

                                                <!-- Input para agregar -->
                                                <div class="flex gap-2 mb-2" x-show="isEditMode || isCreatingNewPlan">
                                                    <input type="text"
                                                           x-model="newActividad"
                                                           @keyup.enter="addActividadToCompetencia(index)"
                                                           class="input input-bordered input-xs flex-1"
                                                           placeholder="Nueva actividad..." />
                                                    <button type="button"
                                                            class="btn btn-primary btn-xs"
                                                            @click="addActividadToCompetencia(index)">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>

                                                <!-- Lista de actividades -->
                                                <div class="space-y-1">
                                                    <template x-for="(actividad, actIndex) in (competencia.actividades || [])" :key="actIndex">
                                                        <div class="flex items-start gap-2 text-xs bg-base-100 p-2 rounded">
                                                            <input type="checkbox"
                                                                   :checked="actividad.completada"
                                                                   @change="toggleActividadCompletada(index, actIndex)"
                                                                   :disabled="!isEditMode && !isCreatingNewPlan"
                                                                   class="checkbox checkbox-xs checkbox-success mt-0.5" />
                                                            <span class="flex-1"
                                                                  :class="actividad.completada ? 'line-through opacity-60' : ''"
                                                                  x-text="actividad.texto"></span>
                                                            <button type="button"
                                                                    class="btn btn-ghost btn-xs text-error"
                                                                    @click="removeActividad(index, actIndex)"
                                                                    x-show="isEditMode || isCreatingNewPlan">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </template>
                                                    <div x-show="!competencia.actividades || competencia.actividades.length === 0"
                                                         class="text-xs text-center opacity-50 py-2">
                                                        No hay actividades definidas
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AN√ÅLISIS: Gr√°ficos y Comparaciones -->
            <div x-show="monthlyView === 'analisis'">
                <!-- Estad√≠sticas de Comparaci√≥n -->
                <div class="stats shadow mb-6 w-full" x-show="planComparison">
                    <div class="stat">
                        <div class="stat-figure text-primary">
                            <i class="fas fa-trophy text-3xl"></i>
                        </div>
                        <div class="stat-title">Total Competencias</div>
                        <div class="stat-value text-primary" x-text="planComparison?.competencias_stats?.total || 0"></div>
                        <div class="stat-desc" x-text="`${planComparison?.competencias_stats?.con_progreso || 0} con progreso final`"></div>
                    </div>

                    <div class="stat">
                        <div class="stat-figure text-secondary">
                            <i class="fas fa-chart-line text-3xl"></i>
                        </div>
                        <div class="stat-title">Progreso Inicial Promedio</div>
                        <div class="stat-value text-secondary" x-text="Math.round(planComparison?.competencias_stats?.promedio_progreso_inicio || 0) + '%'"></div>
                        <div class="stat-desc">Al comenzar el mes</div>
                    </div>

                    <div class="stat">
                        <div class="stat-figure text-success">
                            <i class="fas fa-check-circle text-3xl"></i>
                        </div>
                        <div class="stat-title">Progreso Final Promedio</div>
                        <div class="stat-value text-success" x-text="Math.round(planComparison?.competencias_stats?.promedio_progreso_fin || 0) + '%'"></div>
                        <div class="stat-desc" x-text="`+${Math.round((planComparison?.competencias_stats?.promedio_progreso_fin || 0) - (planComparison?.competencias_stats?.promedio_progreso_inicio || 0))}% de mejora`"></div>
                    </div>
                </div>

                <!-- Gr√°ficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gr√°fico de Comparaci√≥n -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar text-primary"></i>
                                Comparaci√≥n Inicio vs Fin
                            </h3>
                            <div style="height: 400px;">
                                <canvas id="competenciasChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°fico de Evoluci√≥n -->
                    <div class="card bg-base-100 shadow-lg">
                        <div class="card-body">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line text-success"></i>
                                Evoluci√≥n en el Tiempo
                            </h3>
                            <div style="height: 400px;">
                                <canvas id="evolutionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WEEKLY VIEW -->
        <div x-show="currentView === 'weekly'" class="slide-in">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold"><i class="fas fa-book text-primary"></i> Bit√°cora Semanal</h1>
                <button class="btn btn-primary" @click="showNewWeeklyLogModal = true">
                    <i class="fas fa-plus"></i> Nueva Bit√°cora
                </button>
            </div>
            
            <div class="card bg-base-100 shadow-lg">
                <div class="card-body">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Semana del:</span>
                            </label>
                            <input type="date" x-model="weeklyLog.semana_inicio" class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">al:</span>
                            </label>
                            <input type="date" x-model="weeklyLog.semana_fin" class="input input-bordered" />
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Logros de la semana üèÜ</span>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="newLogro" @keyup.enter="addLogro()"
                                   class="input input-bordered flex-1" placeholder="Agregar logro..." />
                            <button type="button" class="btn btn-primary" @click="addLogro()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="space-y-1">
                            <template x-for="(logro, index) in weeklyLog.logros" :key="index">
                                <div class="flex items-center gap-2 bg-base-200 p-2 rounded">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <span class="flex-1" x-text="logro"></span>
                                    <button type="button" class="btn btn-ghost btn-xs" @click="removeLogro(index)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Desaf√≠os enfrentados üí™</span>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="newDesafio" @keyup.enter="addDesafio()"
                                   class="input input-bordered flex-1" placeholder="Agregar desaf√≠o..." />
                            <button type="button" class="btn btn-primary" @click="addDesafio()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="space-y-1">
                            <template x-for="(desafio, index) in weeklyLog.desafios" :key="index">
                                <div class="flex items-center gap-2 bg-base-200 p-2 rounded">
                                    <i class="fas fa-exclamation-triangle text-warning"></i>
                                    <span class="flex-1" x-text="desafio"></span>
                                    <button type="button" class="btn btn-ghost btn-xs" @click="removeDesafio(index)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Aprendizajes üìö</span>
                        </label>
                        <textarea x-model="weeklyLog.aprendizajes" class="textarea textarea-bordered" placeholder="¬øQu√© aprend√≠?" rows="3"></textarea>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Reflexiones üí≠</span>
                        </label>
                        <textarea x-model="weeklyLog.reflexiones" class="textarea textarea-bordered" placeholder="Pensamientos sobre mi progreso..." rows="4"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Nivel de Energ√≠a: <span x-text="weeklyLog.nivel_energia"></span>/5 ‚ö°</span>
                            </label>
                            <input type="range" x-model.number="weeklyLog.nivel_energia" min="1" max="5" class="range range-primary" step="1" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Satisfacci√≥n: <span x-text="weeklyLog.nivel_satisfaccion"></span>/5 üòä</span>
                            </label>
                            <input type="range" x-model.number="weeklyLog.nivel_satisfaccion" min="1" max="5" class="range range-success" step="1" />
                        </div>
                    </div>

                    <button class="btn btn-primary mt-4 btn-block" @click="saveWeeklyLog">
                        <i class="fas fa-save"></i> Guardar Bit√°cora
                    </button>
                </div>
            </div>
            
            <!-- Historial de Bit√°coras -->
            <div class="mt-6">
                <h2 class="text-2xl font-bold mb-4">Historial</h2>
                <div class="grid grid-cols-1 gap-4">
                    <template x-for="(log, index) in weeklyLogs" :key="index">
                        <div class="card bg-base-100 shadow">
                            <div class="card-body">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="card-title text-lg">
                                            Semana <span x-text="formatDate(log.semana_inicio)"></span> - <span x-text="formatDate(log.semana_fin)"></span>
                                        </h3>
                                        <p class="text-sm opacity-70 mt-2" x-text="log.reflexiones"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-ghost btn-sm" @click="viewWeeklyLog(log)" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-ghost btn-sm" @click="editWeeklyLog(log)" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="divider"></div>

                                <!-- Vista resumida -->
                                <div class="space-y-3">
                                    <!-- Logros -->
                                    <div x-show="log.logros && log.logros.length > 0">
                                        <span class="font-semibold text-sm"><i class="fas fa-trophy text-warning"></i> Logros:</span>
                                        <ul class="list-disc list-inside text-sm ml-4">
                                            <template x-for="logro in (log.logros || []).slice(0, 2)" :key="logro">
                                                <li x-text="logro"></li>
                                            </template>
                                            <li x-show="log.logros && log.logros.length > 2" class="opacity-60">
                                                + <span x-text="log.logros.length - 2"></span> m√°s...
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Desaf√≠os -->
                                    <div x-show="log.desafios && log.desafios.length > 0">
                                        <span class="font-semibold text-sm"><i class="fas fa-mountain text-error"></i> Desaf√≠os:</span>
                                        <ul class="list-disc list-inside text-sm ml-4">
                                            <template x-for="desafio in (log.desafios || []).slice(0, 2)" :key="desafio">
                                                <li x-text="desafio"></li>
                                            </template>
                                            <li x-show="log.desafios && log.desafios.length > 2" class="opacity-60">
                                                + <span x-text="log.desafios.length - 2"></span> m√°s...
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Niveles -->
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div>
                                            <span class="font-semibold">Energ√≠a:</span>
                                            <div class="rating rating-sm">
                                                <template x-for="i in 5" :key="i">
                                                    <input type="radio" class="mask mask-star-2 bg-orange-400" :checked="i <= log.nivel_energia" disabled />
                                                </template>
                                            </div>
                                        </div>
                                        <div>
                                            <span class="font-semibold">Satisfacci√≥n:</span>
                                            <div class="rating rating-sm">
                                                <template x-for="i in 5" :key="i">
                                                    <input type="radio" class="mask mask-star-2 bg-green-400" :checked="i <= log.nivel_satisfaccion" disabled />
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- FINANCIAL VIEW -->
        <div x-show="currentView === 'financial'" class="slide-in">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold"><i class="fas fa-dollar-sign text-primary"></i> Control Financiero</h1>

                <!-- Selector de Mes -->
                <input type="month" x-model="selectedMonth" @change="changeFinancialMonth()"
                       class="input input-bordered input-sm" />
            </div>

            <!-- Tabs -->
            <div class="tabs tabs-boxed mb-4">
                <a class="tab" :class="financialView === 'dashboard' ? 'tab-active' : ''"
                   @click="financialView = 'dashboard'">
                    <i class="fas fa-chart-pie mr-2"></i> Dashboard
                </a>
                <a class="tab" :class="financialView === 'registros' ? 'tab-active' : ''"
                   @click="financialView = 'registros'; loadFinancialRecords()">
                    <i class="fas fa-list mr-2"></i> Registros
                </a>
                <a class="tab" :class="financialView === 'categorias' ? 'tab-active' : ''"
                   @click="financialView = 'categorias'">
                    <i class="fas fa-tags mr-2"></i> Categor√≠as
                </a>
            </div>

            <!-- Dashboard Tab -->
            <div x-show="financialView === 'dashboard'" x-cloak>
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- Ingresos -->
                    <div class="stat bg-base-100 rounded-lg shadow">
                        <div class="stat-figure text-success">
                            <i class="fas fa-arrow-up text-3xl"></i>
                        </div>
                        <div class="stat-title">Ingresos</div>
                        <div class="stat-value text-success text-2xl" x-text="formatCurrency(financialSummary?.total_ingresos || 0)"></div>
                    </div>

                    <!-- Gastos -->
                    <div class="stat bg-base-100 rounded-lg shadow">
                        <div class="stat-figure text-error">
                            <i class="fas fa-arrow-down text-3xl"></i>
                        </div>
                        <div class="stat-title">Gastos</div>
                        <div class="stat-value text-error text-2xl" x-text="formatCurrency(financialSummary?.total_gastos || 0)"></div>
                    </div>

                    <!-- Balance -->
                    <div class="stat bg-base-100 rounded-lg shadow">
                        <div class="stat-figure" :class="(financialSummary?.balance || 0) >= 0 ? 'text-success' : 'text-error'">
                            <i class="fas fa-balance-scale text-3xl"></i>
                        </div>
                        <div class="stat-title">Balance</div>
                        <div class="stat-value text-2xl"
                             :class="(financialSummary?.balance || 0) >= 0 ? 'text-success' : 'text-error'"
                             x-text="formatCurrency(financialSummary?.balance || 0)"></div>
                    </div>

                    <!-- Tasa de Ahorro -->
                    <div class="stat bg-base-100 rounded-lg shadow">
                        <div class="stat-figure text-info">
                            <i class="fas fa-piggy-bank text-3xl"></i>
                        </div>
                        <div class="stat-title">Tasa de Ahorro</div>
                        <div class="stat-value text-info text-2xl" x-text="(financialSummary?.tasa_ahorro || 0) + '%'"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gr√°fico de Gastos -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title"><i class="fas fa-chart-pie text-error"></i> Distribuci√≥n de Gastos</h2>
                            <div class="h-64">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Ingresos por Categor√≠a -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title"><i class="fas fa-arrow-up text-success"></i> Ingresos por Categor√≠a</h2>
                            <div class="overflow-x-auto">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Categor√≠a</th>
                                            <th class="text-right">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="item in (financialSummary?.ingresos_por_categoria || [])" :key="item.categoria">
                                            <tr>
                                                <td x-text="item.categoria"></td>
                                                <td class="text-right text-success font-semibold" x-text="formatCurrency(item.monto)"></td>
                                            </tr>
                                        </template>
                                        <tr x-show="!financialSummary || !financialSummary.ingresos_por_categoria || financialSummary.ingresos_por_categoria.length === 0">
                                            <td colspan="2" class="text-center opacity-50">No hay ingresos registrados</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deudas -->
                <div class="card bg-base-100 shadow-xl mt-6" x-show="financialSummary?.total_deudas > 0">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-credit-card text-warning"></i> Deudas Pendientes</h2>
                        <div class="stat-value text-warning" x-text="formatCurrency(financialSummary?.total_deudas || 0)"></div>
                        <div class="overflow-x-auto mt-4">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Categor√≠a</th>
                                        <th class="text-right">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="item in (financialSummary?.deudas_por_categoria || [])" :key="item.categoria">
                                        <tr>
                                            <td x-text="item.categoria"></td>
                                            <td class="text-right text-warning font-semibold" x-text="formatCurrency(item.monto)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registros Tab -->
            <div x-show="financialView === 'registros'" x-cloak>
                <!-- Formulario de Nuevo Registro -->
                <div class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-plus-circle"></i> Nuevo Registro</h2>
                        <form @submit.prevent="saveFinancialRecord()" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Tipo -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Tipo</span></label>
                                <select x-model="newFinancialRecord.tipo" class="select select-bordered" required>
                                    <option value="ingreso">Ingreso</option>
                                    <option value="gasto">Gasto</option>
                                    <option value="deuda">Deuda</option>
                                </select>
                            </div>

                            <!-- Categor√≠a -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Categor√≠a</span></label>
                                <select x-model="newFinancialRecord.category_id" class="select select-bordered" required>
                                    <option value="">Seleccionar...</option>
                                    <template x-for="cat in financialCategories.filter(c => c.tipo === newFinancialRecord.tipo)" :key="cat.id">
                                        <option :value="cat.id">
                                            <span x-text="cat.icono + ' ' + cat.nombre"></span>
                                        </option>
                                    </template>
                                </select>
                            </div>

                            <!-- Monto -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Monto</span></label>
                                <input type="number" step="0.01" x-model="newFinancialRecord.monto"
                                       class="input input-bordered" placeholder="0.00" required />
                            </div>

                            <!-- Fecha -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Fecha</span></label>
                                <input type="date" x-model="newFinancialRecord.fecha_transaccion"
                                       class="input input-bordered" required />
                            </div>

                            <!-- Descripci√≥n -->
                            <div class="form-control md:col-span-2">
                                <label class="label"><span class="label-text">Descripci√≥n</span></label>
                                <input type="text" x-model="newFinancialRecord.descripcion"
                                       class="input input-bordered" placeholder="Detalles..." />
                            </div>

                            <!-- Bot√≥n Guardar -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">&nbsp;</span></label>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de Registros -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-list"></i> Registros del Mes</h2>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Categor√≠a</th>
                                        <th>Descripci√≥n</th>
                                        <th class="text-right">Monto</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="record in financialRecords" :key="record.id">
                                        <tr>
                                            <td x-text="formatDate(record.fecha_transaccion)"></td>
                                            <td>
                                                <span class="badge"
                                                      :class="{
                                                          'badge-success': record.tipo === 'ingreso',
                                                          'badge-error': record.tipo === 'gasto',
                                                          'badge-warning': record.tipo === 'deuda'
                                                      }"
                                                      x-text="record.tipo"></span>
                                            </td>
                                            <td x-text="record.categoria_nombre"></td>
                                            <td x-text="record.descripcion"></td>
                                            <td class="text-right font-semibold"
                                                :class="{
                                                    'text-success': record.tipo === 'ingreso',
                                                    'text-error': record.tipo === 'gasto',
                                                    'text-warning': record.tipo === 'deuda'
                                                }"
                                                x-text="formatCurrency(record.monto)"></td>
                                            <td>
                                                <button @click="deleteFinancialRecord(record.id)"
                                                        class="btn btn-ghost btn-xs text-error">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="financialRecords.length === 0">
                                        <td colspan="6" class="text-center opacity-50">No hay registros para este mes</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categor√≠as Tab -->
            <div x-show="financialView === 'categorias'" x-cloak>
                <!-- Formulario Nueva Categor√≠a -->
                <div class="card bg-base-100 shadow-xl mb-6">
                    <div class="card-body">
                        <h2 class="card-title"><i class="fas fa-plus-circle"></i> Nueva Categor√≠a</h2>
                        <form @submit.prevent="saveFinancialCategory()" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <!-- Nombre -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Nombre</span></label>
                                <input type="text" x-model="newFinancialCategory.nombre"
                                       class="input input-bordered" placeholder="Ej: Restaurantes" required />
                            </div>

                            <!-- Tipo -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Tipo</span></label>
                                <select x-model="newFinancialCategory.tipo" class="select select-bordered" required>
                                    <option value="ingreso">Ingreso</option>
                                    <option value="gasto">Gasto</option>
                                    <option value="deuda">Deuda</option>
                                </select>
                            </div>

                            <!-- Color -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Color</span></label>
                                <input type="color" x-model="newFinancialCategory.color" class="input input-bordered h-12" />
                            </div>

                            <!-- Icono -->
                            <div class="form-control">
                                <label class="label"><span class="label-text">Icono (emoji)</span></label>
                                <input type="text" x-model="newFinancialCategory.icono"
                                       class="input input-bordered" placeholder="üçï" maxlength="2" />
                            </div>

                            <!-- Bot√≥n Guardar -->
                            <div class="form-control md:col-span-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar Categor√≠a
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Categor√≠as por Tipo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Ingresos -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title text-success"><i class="fas fa-arrow-up"></i> Ingresos</h2>
                            <div class="space-y-2">
                                <template x-for="cat in financialCategories.filter(c => c.tipo === 'ingreso')" :key="cat.id">
                                    <div class="flex items-center gap-2 p-2 rounded hover:bg-base-200">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center"
                                             :style="`background-color: ${cat.color}`">
                                            <span x-text="cat.icono"></span>
                                        </div>
                                        <span class="flex-1" x-text="cat.nombre"></span>
                                        <span class="badge badge-sm" x-show="cat.es_predeterminada">Default</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Gastos -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title text-error"><i class="fas fa-arrow-down"></i> Gastos</h2>
                            <div class="space-y-2">
                                <template x-for="cat in financialCategories.filter(c => c.tipo === 'gasto')" :key="cat.id">
                                    <div class="flex items-center gap-2 p-2 rounded hover:bg-base-200">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center"
                                             :style="`background-color: ${cat.color}`">
                                            <span x-text="cat.icono"></span>
                                        </div>
                                        <span class="flex-1" x-text="cat.nombre"></span>
                                        <span class="badge badge-sm" x-show="cat.es_predeterminada">Default</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Deudas -->
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <h2 class="card-title text-warning"><i class="fas fa-credit-card"></i> Deudas</h2>
                            <div class="space-y-2">
                                <template x-for="cat in financialCategories.filter(c => c.tipo === 'deuda')" :key="cat.id">
                                    <div class="flex items-center gap-2 p-2 rounded hover:bg-base-200">
                                        <div class="w-6 h-6 rounded-full flex items-center justify-center"
                                             :style="`background-color: ${cat.color}`">
                                            <span x-text="cat.icono"></span>
                                        </div>
                                        <span class="flex-1" x-text="cat.nombre"></span>
                                        <span class="badge badge-sm" x-show="cat.es_predeterminada">Default</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal: Nueva Tarea -->
    <div x-show="showNewTaskModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black opacity-50" @click="showNewTaskModal = false"></div>

            <!-- Modal Content -->
            <div class="relative bg-base-100 rounded-lg shadow-xl max-w-2xl w-full p-6 z-10">
                <h3 class="text-2xl font-bold mb-4">
                    <i class="fas fa-tasks text-primary"></i> Nueva Tarea
                </h3>

                <form @submit.prevent="createTask">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- T√≠tulo -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text font-semibold">T√≠tulo *</span>
                            </label>
                            <input type="text" x-model="newTask.titulo" class="input input-bordered" placeholder="Ej: Completar proyecto X" required />
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Descripci√≥n</span>
                            </label>
                            <textarea x-model="newTask.descripcion" class="textarea textarea-bordered" rows="2" placeholder="Detalles de la tarea..."></textarea>
                        </div>

                        <!-- Clasificaci√≥n -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Clasificaci√≥n</span>
                                <button type="button" class="btn btn-ghost btn-xs" @click="showAddClasificacion = !showAddClasificacion" title="Agregar nueva clasificaci√≥n">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </label>
                            <div x-show="showAddClasificacion" class="mb-2">
                                <div class="join w-full">
                                    <input type="text" x-model="nuevaClasificacion" class="input input-bordered input-sm join-item flex-1" placeholder="Ej: desarrollo-web" />
                                    <button type="button" class="btn btn-sm btn-primary join-item" @click="addClasificacion">Agregar</button>
                                </div>
                            </div>
                            <select x-model="newTask.clasificacion" class="select select-bordered">
                                <option value="">Seleccionar...</option>
                                <template x-for="clasificacion in userConfig.clasificaciones" :key="clasificacion">
                                    <option :value="clasificacion" x-text="clasificacion"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Categor√≠a -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Categor√≠a *</span>
                                <button type="button" class="btn btn-ghost btn-xs" @click="showAddCategoria = !showAddCategoria" title="Agregar nueva categor√≠a">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </label>
                            <div x-show="showAddCategoria" class="mb-2">
                                <div class="join w-full">
                                    <input type="text" x-model="nuevaCategoria" class="input input-bordered input-sm join-item flex-1" placeholder="Ej: proyecto" />
                                    <button type="button" class="btn btn-sm btn-primary join-item" @click="addCategoria">Agregar</button>
                                </div>
                            </div>
                            <select x-model="newTask.categoria" class="select select-bordered" required>
                                <template x-for="categoria in userConfig.categorias" :key="categoria">
                                    <option :value="categoria" x-text="categoria"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Fecha Inicio -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Fecha Inicio *</span>
                            </label>
                            <input type="date" x-model="newTask.fecha_inicio" class="input input-bordered" required />
                        </div>

                        <!-- Fecha Fin -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Fecha Fin *</span>
                            </label>
                            <input type="date" x-model="newTask.fecha_fin" class="input input-bordered" required />
                        </div>

                        <!-- Estado -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Estado</span>
                            </label>
                            <select x-model="newTask.estado" class="select select-bordered">
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En Progreso</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>

                        <!-- Prioridad -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Prioridad</span>
                            </label>
                            <select x-model="newTask.prioridad" class="select select-bordered">
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>

                        <!-- Es Macrotarea -->
                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <span class="label-text">Es Macrotarea (tiene subtareas)</span>
                                <input type="checkbox" x-model="newTask.es_macrotarea" class="checkbox checkbox-primary" />
                            </label>
                        </div>

                        <!-- Tarea Padre -->
                        <div class="form-control" x-show="!newTask.es_macrotarea">
                            <label class="label">
                                <span class="label-text">Tarea Padre (subtarea de...)</span>
                            </label>
                            <select x-model="newTask.parent_task_id" class="select select-bordered">
                                <option value="">Ninguna (tarea independiente)</option>
                                <template x-for="task in tasks.filter(t => t.es_macrotarea)" :key="task.id">
                                    <option :value="task.id" x-text="task.titulo"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Progreso -->
                        <div class="form-control md:col-span-2" x-show="!newTask.es_macrotarea">
                            <label class="label">
                                <span class="label-text">Progreso: <span x-text="newTask.progreso + '%'"></span></span>
                            </label>
                            <input type="range" x-model.number="newTask.progreso" min="0" max="100" step="5" class="range range-primary"
                                   @input="updateEstadoByProgreso(newTask)" />
                            <div class="text-xs text-warning mt-1" x-show="newTask.progreso > 90">
                                ‚ö†Ô∏è Progreso mayor al 90% - Se requieren evidencias
                            </div>
                            <div class="w-full flex justify-between text-xs px-2">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>
                        </div>

                        <!-- Tiempo Estimado -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Tiempo Estimado (horas)</span>
                            </label>
                            <input type="number" x-model.number="newTask.tiempo_estimado" class="input input-bordered" placeholder="8" min="0" step="0.5" />
                        </div>

                        <!-- Observaciones -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Observaciones</span>
                            </label>
                            <textarea x-model="newTask.observaciones" class="textarea textarea-bordered" rows="2" placeholder="Notas adicionales, comentarios, requisitos especiales..."></textarea>
                        </div>
                    </div>

                    <!-- Info sobre Macrotareas -->
                    <div x-show="newTask.es_macrotarea" class="alert alert-info mt-4">
                        <i class="fas fa-info-circle"></i>
                        <span class="text-sm">Las macrotareas agrupan subtareas. Su progreso se calcula autom√°ticamente del promedio de sus subtareas.</span>
                    </div>

                    <!-- Botones -->
                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" @click="showNewTaskModal = false">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Crear Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Tarea -->
    <div x-show="showEditTaskModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <!-- Overlay -->
            <div class="fixed inset-0 bg-black opacity-50" @click="showEditTaskModal = false"></div>

            <!-- Modal Content -->
            <div class="relative bg-base-100 rounded-lg shadow-xl max-w-2xl w-full p-6 z-10" x-show="editingTask">
                <h3 class="text-2xl font-bold mb-4">
                    <i class="fas fa-edit text-primary"></i> Editar Tarea
                </h3>

                <form @submit.prevent="updateTask">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- T√≠tulo -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text font-semibold">T√≠tulo *</span>
                            </label>
                            <input type="text" x-model="editingTask.titulo" class="input input-bordered" required />
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Descripci√≥n</span>
                            </label>
                            <textarea x-model="editingTask.descripcion" class="textarea textarea-bordered" rows="2"></textarea>
                        </div>

                        <!-- Clasificaci√≥n -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Clasificaci√≥n</span>
                            </label>
                            <select x-model="editingTask.clasificacion" class="select select-bordered">
                                <option value="">Seleccionar...</option>
                                <template x-for="clasificacion in userConfig.clasificaciones" :key="clasificacion">
                                    <option :value="clasificacion" x-text="clasificacion"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Categor√≠a -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Categor√≠a *</span>
                            </label>
                            <select x-model="editingTask.categoria" class="select select-bordered" required>
                                <template x-for="categoria in userConfig.categorias" :key="categoria">
                                    <option :value="categoria" x-text="categoria"></option>
                                </template>
                            </select>
                        </div>

                        <!-- Fecha Inicio -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Fecha Inicio *</span>
                            </label>
                            <input type="date" x-model="editingTask.fecha_inicio" class="input input-bordered" required />
                        </div>

                        <!-- Fecha Fin -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Fecha Fin *</span>
                            </label>
                            <input type="date" x-model="editingTask.fecha_fin" class="input input-bordered" required />
                        </div>

                        <!-- Estado -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Estado</span>
                            </label>
                            <select x-model="editingTask.estado" class="select select-bordered">
                                <option value="pendiente">Pendiente</option>
                                <option value="en_progreso">En Progreso</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>

                        <!-- Prioridad -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Prioridad</span>
                            </label>
                            <select x-model="editingTask.prioridad" class="select select-bordered">
                                <option value="baja">Baja</option>
                                <option value="media">Media</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>

                        <!-- Progreso -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Progreso (%): <span x-text="editingTask.progreso || 0"></span>%</span>
                            </label>
                            <input type="range" x-model="editingTask.progreso" min="0" max="100" class="range range-primary"
                                   @input="updateEstadoByProgreso(editingTask)" />
                            <div class="text-xs text-warning mt-1" x-show="editingTask.progreso > 90">
                                ‚ö†Ô∏è Progreso mayor al 90% - Se requieren evidencias
                            </div>
                        </div>

                        <!-- Es Macrotarea -->
                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <span class="label-text">¬øEs una Macrotarea?</span>
                                <input type="checkbox" x-model="editingTask.es_macrotarea" class="checkbox checkbox-primary" />
                            </label>
                        </div>

                        <!-- Observaciones -->
                        <div class="form-control md:col-span-2">
                            <label class="label">
                                <span class="label-text">Observaciones</span>
                            </label>
                            <textarea x-model="editingTask.observaciones" class="textarea textarea-bordered" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="modal-action">
                        <button type="button" class="btn btn-ghost" @click="showEditTaskModal = false">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Bit√°cora Semanal -->
    <div x-show="showViewWeeklyLogModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showViewWeeklyLogModal = false"></div>

            <div class="relative bg-base-100 rounded-lg shadow-xl max-w-3xl w-full p-6 z-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">
                        <i class="fas fa-book text-primary"></i> Bit√°cora Semanal
                    </h3>
                    <button class="btn btn-ghost btn-sm" @click="showViewWeeklyLogModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div x-show="viewingWeeklyLog" class="space-y-4">
                    <!-- Fechas -->
                    <div class="alert alert-info">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Semana del <strong x-text="viewingWeeklyLog ? formatDate(viewingWeeklyLog.semana_inicio) : ''"></strong> al <strong x-text="viewingWeeklyLog ? formatDate(viewingWeeklyLog.semana_fin) : ''"></strong></span>
                    </div>

                    <!-- Logros -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-trophy text-warning"></i> Logros</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <template x-for="logro in (viewingWeeklyLog?.logros || [])" :key="logro">
                                    <li x-text="logro"></li>
                                </template>
                            </ul>
                            <div x-show="!viewingWeeklyLog?.logros || viewingWeeklyLog.logros.length === 0" class="text-center opacity-50">
                                Sin logros registrados
                            </div>
                        </div>
                    </div>

                    <!-- Desaf√≠os -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-mountain text-error"></i> Desaf√≠os</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <template x-for="desafio in (viewingWeeklyLog?.desafios || [])" :key="desafio">
                                    <li x-text="desafio"></li>
                                </template>
                            </ul>
                            <div x-show="!viewingWeeklyLog?.desafios || viewingWeeklyLog.desafios.length === 0" class="text-center opacity-50">
                                Sin desaf√≠os registrados
                            </div>
                        </div>
                    </div>

                    <!-- Aprendizajes -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-lightbulb text-warning"></i> Aprendizajes</h4>
                            <p x-text="viewingWeeklyLog?.aprendizajes || 'Sin aprendizajes registrados'"></p>
                        </div>
                    </div>

                    <!-- Reflexiones -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-comment-dots text-info"></i> Reflexiones</h4>
                            <p x-text="viewingWeeklyLog?.reflexiones || 'Sin reflexiones registradas'"></p>
                        </div>
                    </div>

                    <!-- Niveles -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card bg-base-200">
                            <div class="card-body">
                                <h4 class="card-title text-sm">‚ö° Nivel de Energ√≠a</h4>
                                <div class="rating rating-lg">
                                    <template x-for="i in 5" :key="i">
                                        <input type="radio" class="mask mask-star-2 bg-orange-400" :checked="i <= (viewingWeeklyLog?.nivel_energia || 0)" disabled />
                                    </template>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-base-200">
                            <div class="card-body">
                                <h4 class="card-title text-sm">üòä Satisfacci√≥n</h4>
                                <div class="rating rating-lg">
                                    <template x-for="i in 5" :key="i">
                                        <input type="radio" class="mask mask-star-2 bg-green-400" :checked="i <= (viewingWeeklyLog?.nivel_satisfaccion || 0)" disabled />
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex gap-2 justify-end">
                        <button class="btn btn-primary" @click="showViewWeeklyLogModal = false; editWeeklyLog(viewingWeeklyLog)">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-ghost" @click="showViewWeeklyLogModal = false">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Bit√°cora Semanal -->
    <div x-show="showEditWeeklyLogModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showEditWeeklyLogModal = false"></div>

            <div class="relative bg-base-100 rounded-lg shadow-xl max-w-3xl w-full p-6 z-10 max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">
                        <i class="fas fa-edit text-primary"></i> Editar Bit√°cora Semanal
                    </h3>
                    <button class="btn btn-ghost btn-sm" @click="showEditWeeklyLogModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form x-show="editingWeeklyLog" @submit.prevent="updateWeeklyLog()" class="space-y-4">
                    <!-- Fechas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text">Semana Inicio</span></label>
                            <input type="date" x-model="editingWeeklyLog.semana_inicio" class="input input-bordered" required />
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">Semana Fin</span></label>
                            <input type="date" x-model="editingWeeklyLog.semana_fin" class="input input-bordered" required />
                        </div>
                    </div>

                    <!-- Logros -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-trophy text-warning"></i> Logros</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="text" x-model="newLogro" @keyup.enter="addLogroEdit()"
                                       class="input input-bordered flex-1" placeholder="Agregar logro..." />
                                <button type="button" class="btn btn-primary" @click="addLogroEdit()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <template x-for="(logro, index) in (editingWeeklyLog?.logros || [])" :key="index">
                                    <div class="flex items-center gap-2 bg-base-100 p-2 rounded">
                                        <i class="fas fa-check-circle text-success"></i>
                                        <span class="flex-1" x-text="logro"></span>
                                        <button type="button" class="btn btn-ghost btn-xs text-error" @click="removeLogroEdit(index)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Desaf√≠os -->
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title text-lg"><i class="fas fa-mountain text-error"></i> Desaf√≠os</h4>
                            <div class="flex gap-2 mb-2">
                                <input type="text" x-model="newDesafio" @keyup.enter="addDesafioEdit()"
                                       class="input input-bordered flex-1" placeholder="Agregar desaf√≠o..." />
                                <button type="button" class="btn btn-primary" @click="addDesafioEdit()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="space-y-2">
                                <template x-for="(desafio, index) in (editingWeeklyLog?.desafios || [])" :key="index">
                                    <div class="flex items-center gap-2 bg-base-100 p-2 rounded">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <span class="flex-1" x-text="desafio"></span>
                                        <button type="button" class="btn btn-ghost btn-xs text-error" @click="removeDesafioEdit(index)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Aprendizajes -->
                    <div class="form-control">
                        <label class="label"><span class="label-text">Aprendizajes üìö</span></label>
                        <textarea x-model="editingWeeklyLog.aprendizajes" class="textarea textarea-bordered" rows="3"
                                  placeholder="¬øQu√© aprendiste esta semana?"></textarea>
                    </div>

                    <!-- Reflexiones -->
                    <div class="form-control">
                        <label class="label"><span class="label-text">Reflexiones üí≠</span></label>
                        <textarea x-model="editingWeeklyLog.reflexiones" class="textarea textarea-bordered" rows="3"
                                  placeholder="Pensamientos sobre mi progreso..."></textarea>
                    </div>

                    <!-- Niveles -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Nivel de Energ√≠a: <span x-text="editingWeeklyLog?.nivel_energia || 3"></span>/5 ‚ö°</span>
                            </label>
                            <input type="range" x-model.number="editingWeeklyLog.nivel_energia" min="1" max="5" class="range range-primary" step="1" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Satisfacci√≥n: <span x-text="editingWeeklyLog?.nivel_satisfaccion || 3"></span>/5 üòä</span>
                            </label>
                            <input type="range" x-model.number="editingWeeklyLog.nivel_satisfaccion" min="1" max="5" class="range range-success" step="1" />
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex gap-2 justify-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-ghost" @click="showEditWeeklyLogModal = false">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast toast-end" x-show="showToast" x-transition>
        <div class="alert" :class="toastType === 'success' ? 'alert-success' : 'alert-error'">
            <span x-text="toastMessage"></span>
        </div>
    </div>
    
    <!-- Alpine.js Data -->
    <script>
        function appData() {
            return {
                // Estado general
                currentView: 'dashboard',
                taskView: 'list',
                monthlyView: 'gestion',
                userInitials: 'U',
                showToast: false,
                toastMessage: '',
                toastType: 'success',
                showSubtasks: true,

                // Filtros de tareas
                filterEstado: '',
                filterPrioridad: '',
                filterClasificacion: '',
                filterFecha: '',

                // Datos
                stats: {
                    totalTasks: 0,
                    completedTasks: 0,
                    pendingTasks: 0,
                    completionRate: 0,
                    weeklyLogsCount: 0
                },
                tasks: [],
                recentTasks: [],
                weeklyLogs: [],
                draggedTask: null,

                // Modales
                showNewTaskModal: false,
                showEditTaskModal: false,
                showNewMonthlyPlanModal: false,
                showNewWeeklyLogModal: false,
                showViewWeeklyLogModal: false,
                showEditWeeklyLogModal: false,
                showAddClasificacion: false,
                showAddCategoria: false,

                // Tarea en edici√≥n
                editingTask: null,
                viewingWeeklyLog: null,
                editingWeeklyLog: null,

                // Configuraci√≥n de usuario
                userConfig: {
                    clasificaciones: ['desarrollo', 'investigacion', 'documentacion', 'reunion', 'estudio', 'revision', 'planificacion', 'testing'],
                    categorias: ['aprendizaje', 'compromiso', 'competencia', 'personal']
                },
                nuevaClasificacion: '',
                nuevaCategoria: '',

                // Datos de formularios
                newTask: {
                    titulo: '',
                    descripcion: '',
                    clasificacion: '',
                    categoria: 'personal',
                    fecha_inicio: new Date().toISOString().split('T')[0],
                    fecha_fin: new Date().toISOString().split('T')[0],
                    estado: 'pendiente',
                    prioridad: 'media',
                    progreso: 0,
                    es_macrotarea: false,
                    parent_task_id: '',
                    tiempo_estimado: null,
                    observaciones: ''
                },

                monthlyPlan: {
                    mes: new Date().toISOString().substring(0, 7), // YYYY-MM
                    competencias_trabajar: '',
                    competencias: [],
                    que_quiero_lograr: '',
                    actividades_lograr: [],
                    mis_fortalezas: '',
                    mis_debilidades: ''
                },
                newActividadLograr: '',

                currentPlanId: null,
                monthlyPlans: [],
                competenciasEvolution: {},
                planComparison: null,

                // Estados para modo visualizaci√≥n/edici√≥n
                isEditMode: false,
                isCreatingNewPlan: false,
                viewingPlanId: null,
                monthAlreadyExists: false,

                newCompetencia: {
                    nombre: '',
                    progreso_inicio: 0,
                    progreso_actual: 0,
                    progreso_fin: null,
                    notas: '',
                    actividades: []
                },
                newActividad: '',

                monthlyReview: {
                    que_mejore: '',
                    que_falta_mejorar: '',
                    habilidades_desarrolladas: '',
                    momento_memorable: ''
                },

                // Charts
                weeklyChart: null,
                categoryChart: null,
                competenciasChart: null,
                evolutionChart: null,

                weeklyLog: {
                    semana_inicio: new Date().toISOString().split('T')[0],
                    semana_fin: new Date().toISOString().split('T')[0],
                    logros: [],
                    desafios: [],
                    aprendizajes: '',
                    reflexiones: '',
                    nivel_energia: 3,
                    nivel_satisfaccion: 3
                },
                newLogro: '',
                newDesafio: '',

                // Financial Control
                financialView: 'dashboard',
                financialCategories: [],
                financialRecords: [],
                financialSummary: null,
                selectedMonth: new Date().toISOString().split('T')[0].substring(0, 7),
                newFinancialRecord: {
                    mes: new Date().toISOString().split('T')[0],
                    fecha_transaccion: new Date().toISOString().split('T')[0],
                    tipo: 'gasto',
                    monto: 0,
                    descripcion: '',
                    category_id: ''
                },
                newFinancialCategory: {
                    nombre: '',
                    tipo: 'gasto',
                    color: '#6366f1',
                    icono: ''
                },
                expensesChart: null,

                // Inicializaci√≥n
                async init() {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        window.location.href = '/login';
                        return;
                    }

                    this.userInitials = this.getUserInitials();
                    await this.loadUserConfig();
                    await this.loadDashboardData();
                    await this.loadTasks();
                    await this.loadWeeklyLogs();
                    await this.loadMonthlyPlans();
                    await this.loadCompetenciasEvolution();
                    this.initCharts();
                    await this.loadFinancialCategories();
                    await this.loadFinancialSummary();
                },
                
                getUserInitials() {
                    const email = localStorage.getItem('user_email') || 'user@example.com';
                    return email.charAt(0).toUpperCase();
                },
                
                async loadDashboardData() {
                    try {
                        const response = await this.apiCall('/api/dashboard/summary');
                        if (response) {
                            this.stats = response;
                        }
                    } catch (error) {
                        console.error('Error loading dashboard:', error);
                    }
                },
                
                async loadTasks() {
                    try {
                        const response = await this.apiCall('/api/tasks');
                        if (response) {
                            this.tasks = response;
                            this.recentTasks = response.slice(0, 5);
                        }
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                    }
                },
                
                async loadWeeklyLogs() {
                    try {
                        const response = await this.apiCall('/api/weekly/logs');
                        if (response) {
                            // Normalizar los datos para asegurar que logros y desaf√≠os sean arrays
                            this.weeklyLogs = response.map(log => ({
                                ...log,
                                logros: Array.isArray(log.logros) ? log.logros : (log.logros ? [log.logros] : []),
                                desafios: Array.isArray(log.desafios) ? log.desafios : (log.desafios ? [log.desafios] : [])
                            }));
                        }
                    } catch (error) {
                        console.error('Error loading weekly logs:', error);
                    }
                },

                async loadUserConfig() {
                    try {
                        const response = await this.apiCall('/api/config');
                        if (response) {
                            this.userConfig = {
                                clasificaciones: response.clasificaciones || [],
                                categorias: response.categorias || []
                            };
                        }
                    } catch (error) {
                        console.error('Error loading user config:', error);
                    }
                },

                async addClasificacion() {
                    if (!this.nuevaClasificacion.trim()) {
                        this.showNotification('Ingresa un nombre para la clasificaci√≥n', 'error');
                        return;
                    }

                    try {
                        const response = await this.apiCall('/api/config/clasificaciones', 'POST', {
                            nombre: this.nuevaClasificacion.trim()
                        });

                        if (response) {
                            this.userConfig.clasificaciones = response.clasificaciones;
                            this.nuevaClasificacion = '';
                            this.showAddClasificacion = false;
                            this.showNotification('Clasificaci√≥n agregada', 'success');
                        }
                    } catch (error) {
                        this.showNotification('Error al agregar clasificaci√≥n', 'error');
                    }
                },

                async addCategoria() {
                    if (!this.nuevaCategoria.trim()) {
                        this.showNotification('Ingresa un nombre para la categor√≠a', 'error');
                        return;
                    }

                    try {
                        const response = await this.apiCall('/api/config/categorias', 'POST', {
                            nombre: this.nuevaCategoria.trim()
                        });

                        if (response) {
                            this.userConfig.categorias = response.categorias;
                            this.nuevaCategoria = '';
                            this.showAddCategoria = false;
                            this.showNotification('Categor√≠a agregada', 'success');
                        }
                    } catch (error) {
                        this.showNotification('Error al agregar categor√≠a', 'error');
                    }
                },

                async apiCall(endpoint, method = 'GET', data = null) {
                    const token = localStorage.getItem('access_token');
                    const options = {
                        method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    };
                    
                    if (data && method !== 'GET') {
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(endpoint, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error('API call failed');
                },
                
                // Funciones de utilidad
                formatDate(dateString) {
                    if (!dateString) return '';
                    // Evitar problemas de timezone - parsear fecha como local
                    const parts = dateString.split('-');
                    if (parts.length >= 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // Meses en JS son 0-indexed
                        const day = parseInt(parts[2].split('T')[0]); // Remover tiempo si existe
                        const date = new Date(year, month, day);
                        return date.toLocaleDateString('es-ES');
                    }
                    return dateString;
                },

                capitalize(str) {
                    if (!str) return '';
                    // Reemplazar guiones bajos con espacios y capitalizar
                    return str.replace(/_/g, ' ').split(' ').map(word =>
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                },

                formatMonth(dateString) {
                    if (!dateString) return '';
                    try {
                        // Extraer a√±o y mes del string
                        const parts = dateString.split('-');
                        const year = parseInt(parts[0]);
                        const monthIndex = parseInt(parts[1]) - 1;

                        if (isNaN(year) || isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) {
                            return dateString; // Retornar original si no se puede parsear
                        }

                        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        return `${months[monthIndex]} ${year}`;
                    } catch (error) {
                        console.error('Error formatting month:', error, dateString);
                        return dateString;
                    }
                },

                // Convertir fecha sin timezone offset
                toLocalISODate(dateInput) {
                    if (!dateInput) return null;
                    // Si es string en formato YYYY-MM-DD o YYYY-MM, retornar directamente
                    if (typeof dateInput === 'string') {
                        return dateInput;
                    }
                    // Si es Date object, extraer fecha local
                    const date = new Date(dateInput);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                },

                getStatusBadgeClass(status) {
                    const classes = {
                        'pendiente': 'badge-warning',
                        'en_progreso': 'badge-info',
                        'completada': 'badge-success',
                        'cancelada': 'badge-error'
                    };
                    return classes[status] || '';
                },
                
                getPriorityBadgeClass(priority) {
                    const classes = {
                        'alta': 'badge-error',
                        'media': 'badge-warning',
                        'baja': 'badge-success'
                    };
                    return classes[priority] || '';
                },

                updateEstadoByProgreso(task) {
                    // Actualizar estado autom√°ticamente seg√∫n progreso
                    const progreso = parseInt(task.progreso) || 0;

                    if (progreso === 0) {
                        task.estado = 'pendiente';
                    } else if (progreso > 0 && progreso < 100) {
                        task.estado = 'en_progreso';
                    } else if (progreso === 100) {
                        task.estado = 'completada';
                    }
                },

                getTasksByStatus(status) {
                    return this.filteredTasks.filter(task => task.estado === status);
                },
                
                // Drag and Drop Handlers
                handleDragStart(event, task) {
                    this.draggedTask = task;
                    event.target.classList.add('dragging');
                },
                
                handleDragEnd(event) {
                    event.target.classList.remove('dragging');
                    document.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                },
                
                async handleDrop(event, newStatus) {
                    event.preventDefault();
                    event.target.classList.remove('drag-over');
                    
                    if (this.draggedTask && this.draggedTask.estado !== newStatus) {
                        try {
                            await this.apiCall(`/api/tasks/${this.draggedTask.id}`, 'PUT', {
                                estado: newStatus
                            });
                            
                            // Actualizar estado local
                            const task = this.tasks.find(t => t.id === this.draggedTask.id);
                            if (task) {
                                task.estado = newStatus;
                            }
                            
                            this.showNotification('Tarea actualizada correctamente', 'success');
                        } catch (error) {
                            this.showNotification('Error al actualizar tarea', 'error');
                        }
                    }
                    
                    this.draggedTask = null;
                },
                
                // CRUD Operations
                async createTask() {
                    try {
                        const response = await this.apiCall('/api/tasks', 'POST', this.newTask);

                        if (response) {
                            this.showNotification('Tarea creada exitosamente', 'success');
                            this.showNewTaskModal = false;

                            // Si es una subtarea, recalcular fechas de la macrotarea padre
                            const parentTaskId = this.newTask.parent_task_id;

                            await this.loadTasks();
                            await this.loadDashboardData();

                            // Recalcular fechas de macrotarea si es subtarea
                            if (parentTaskId) {
                                await this.recalcularFechasMacrotarea(parentTaskId);
                            }

                            // Reset form
                            this.newTask = {
                                titulo: '',
                                descripcion: '',
                                clasificacion: '',
                                categoria: 'personal',
                                fecha_inicio: new Date().toISOString().split('T')[0],
                                fecha_fin: new Date().toISOString().split('T')[0],
                                estado: 'pendiente',
                                prioridad: 'media',
                                progreso: 0,
                                es_macrotarea: false,
                                parent_task_id: '',
                                tiempo_estimado: null,
                                observaciones: ''
                            };
                        }
                    } catch (error) {
                        this.showNotification('Error al crear tarea: ' + error.message, 'error');
                    }
                },

                async deleteTask(taskId) {
                    if (!confirm('¬øEst√°s seguro de eliminar esta tarea?')) return;

                    try {
                        // Obtener parent_task_id antes de eliminar
                        const task = this.tasks.find(t => t.id === taskId);
                        const parentTaskId = task ? task.parent_task_id : null;

                        await this.apiCall(`/api/tasks/${taskId}`, 'DELETE');
                        this.tasks = this.tasks.filter(t => t.id !== taskId);
                        this.showNotification('Tarea eliminada', 'success');
                        await this.loadDashboardData();

                        // Si era una subtarea, recalcular fechas de la macrotarea padre
                        if (parentTaskId) {
                            await this.recalcularFechasMacrotarea(parentTaskId);
                        }
                    } catch (error) {
                        this.showNotification('Error al eliminar tarea', 'error');
                    }
                },

                editTask(task) {
                    // Cargar los datos de la tarea en el formulario de edici√≥n
                    this.editingTask = { ...task };
                    this.showEditTaskModal = true;
                },

                async updateTask() {
                    try {
                        const taskId = this.editingTask.id;
                        const parentTaskId = this.editingTask.parent_task_id;
                        const response = await this.apiCall(`/api/tasks/${taskId}`, 'PUT', this.editingTask);

                        if (response) {
                            this.showNotification('Tarea actualizada exitosamente', 'success');
                            this.showEditTaskModal = false;
                            await this.loadTasks();
                            await this.loadDashboardData();

                            // Si es una subtarea, recalcular fechas de la macrotarea padre
                            if (parentTaskId) {
                                await this.recalcularFechasMacrotarea(parentTaskId);
                            }

                            this.editingTask = null;
                        }
                    } catch (error) {
                        this.showNotification('Error al actualizar tarea: ' + error.message, 'error');
                    }
                },

                async recalcularFechasMacrotarea(macrotareaId) {
                    try {
                        const response = await this.apiCall(`/api/tasks/${macrotareaId}/recalcular-fechas`, 'PUT');
                        if (response && response.message !== 'No hay subtareas' && response.message !== 'Las subtareas no tienen fechas definidas') {
                            // Actualizar la tarea en el array local
                            const taskIndex = this.tasks.findIndex(t => t.id === macrotareaId);
                            if (taskIndex !== -1) {
                                this.tasks[taskIndex].fecha_inicio = response.fecha_inicio;
                                this.tasks[taskIndex].fecha_fin = response.fecha_fin;
                            }
                        }
                    } catch (error) {
                        console.error('Error al recalcular fechas:', error);
                    }
                },

                // Plan Mensual y Bit√°coras
                async loadMonthlyPlans() {
                    try {
                        const response = await this.apiCall('/api/monthly/plans');
                        if (response) {
                            this.monthlyPlans = response;
                            if (response.length > 0) {
                                this.currentPlanId = response[0].id;
                                this.monthlyPlan = {...response[0]};
                            }
                        }
                    } catch (error) {
                        console.error('Error loading monthly plans:', error);
                    }
                },

                async loadCompetenciasEvolution() {
                    try {
                        const response = await this.apiCall('/api/monthly/evolution?months=6');
                        if (response) {
                            this.competenciasEvolution = response.evolution;
                            this.renderEvolutionChart();
                        }
                    } catch (error) {
                        console.error('Error loading evolution:', error);
                    }
                },

                async loadExistingPlan(planId) {
                    if (!planId) return;

                    try {
                        const plan = await this.apiCall(`/api/monthly/plans/${planId}`);

                        if (plan) {
                            // Poblar formulario - convertir fecha YYYY-MM-DD a YYYY-MM para input type="month"
                            let mesFormato = plan.mes;
                            if (mesFormato && mesFormato.length > 7) {
                                mesFormato = mesFormato.substring(0, 7); // Extraer YYYY-MM
                            }

                            this.monthlyPlan = {
                                mes: mesFormato,
                                competencias_trabajar: plan.competencias_trabajar || '',
                                competencias: plan.competencias || [],
                                que_quiero_lograr: plan.que_quiero_lograr || '',
                                actividades_lograr: plan.actividades_lograr || [],
                                mis_fortalezas: plan.mis_fortalezas || '',
                                mis_debilidades: plan.mis_debilidades || ''
                            };

                            // Modo visualizaci√≥n
                            this.isEditMode = false;
                            this.isCreatingNewPlan = false;
                            this.viewingPlanId = planId;

                            await this.loadPlanComparison(planId);

                            // Cargar review si existe
                            try {
                                const review = await this.apiCall(`/api/monthly/reviews/${planId}`);
                                if (review) {
                                    this.monthlyReview = {
                                        que_mejore: review.que_mejore || '',
                                        que_falta_mejorar: review.que_falta_mejorar || '',
                                        habilidades_desarrolladas: review.habilidades_desarrolladas || '',
                                        momento_memorable: review.momento_memorable || ''
                                    };
                                }
                            } catch (e) {
                                console.log('No review found');
                            }
                        }
                    } catch (error) {
                        this.showNotification('Error al cargar plan: ' + error.message, 'error');
                    }
                },

                async loadPlanComparison(planId) {
                    try {
                        const response = await this.apiCall(`/api/monthly/comparison/${planId}`);
                        if (response) {
                            this.planComparison = response;
                            this.renderCompetenciasChart();
                        }
                    } catch (error) {
                        console.error('Error loading comparison:', error);
                    }
                },

                createNewPlan() {
                    // Limpiar formularios
                    this.monthlyPlan = {
                        mes: new Date().toISOString().split('T')[0],
                        competencias_trabajar: '',
                        competencias: [],
                        que_quiero_lograr: '',
                        actividades_lograr: [],
                        mis_fortalezas: '',
                        mis_debilidades: ''
                    };

                    this.monthlyReview = {
                        que_mejore: '',
                        que_falta_mejorar: '',
                        habilidades_desarrolladas: '',
                        momento_memorable: ''
                    };

                    // Activar modo edici√≥n
                    this.isEditMode = true;
                    this.isCreatingNewPlan = true;
                    this.viewingPlanId = null;
                    this.currentPlanId = null;

                    // Cambiar a pesta√±a Gesti√≥n
                    this.monthlyView = 'gestion';

                    this.showNotification('Creando nuevo plan mensual', 'info');
                },

                enableEditMode() {
                    this.isEditMode = true;
                    this.showNotification('Modo edici√≥n activado', 'info');
                },

                cancelEdit() {
                    if (this.viewingPlanId) {
                        this.loadExistingPlan(this.viewingPlanId);
                    }
                    this.isEditMode = false;
                    this.showNotification('Edici√≥n cancelada', 'info');
                },

                async updateMonthlyPlan() {
                    if (!this.viewingPlanId) {
                        this.showNotification('Error: No hay plan para actualizar', 'error');
                        return;
                    }

                    try {
                        // Preparar datos - convertir mes formato YYYY-MM a YYYY-MM-01
                        const planData = { ...this.monthlyPlan };
                        if (planData.mes && planData.mes.length === 7) {
                            planData.mes = planData.mes + '-01';
                        }

                        const response = await this.apiCall(
                            `/api/monthly/plans/${this.viewingPlanId}`,
                            'PUT',
                            planData
                        );

                        if (response) {
                            this.showNotification('Plan actualizado exitosamente', 'success');
                            this.isEditMode = false;
                            await this.loadMonthlyPlans();
                        }
                    } catch (error) {
                        this.showNotification('Error al actualizar: ' + error.message, 'error');
                    }
                },

                async saveMonthlyPlan() {
                    // Validar que se haya seleccionado un mes
                    if (!this.monthlyPlan.mes) {
                        this.showNotification('Por favor selecciona un mes', 'error');
                        return;
                    }

                    // Verificar si ya existe un plan para este mes
                    const existingPlan = this.monthlyPlans.find(p => p.mes === this.monthlyPlan.mes);

                    if (existingPlan && this.isCreatingNewPlan) {
                        const confirmed = confirm(
                            `Ya existe un plan para ${this.formatDate(this.monthlyPlan.mes)}.\n\n` +
                            `¬øDeseas editar el plan existente?`
                        );

                        if (confirmed) {
                            // Cambiar a modo edici√≥n del plan existente
                            this.currentPlanId = existingPlan.id;
                            this.viewingPlanId = existingPlan.id;
                            this.isCreatingNewPlan = false;
                            await this.loadExistingPlan(existingPlan.id);
                            this.enableEditMode();
                            return;
                        } else {
                            return;
                        }
                    }

                    try {
                        // Preparar datos - convertir mes formato YYYY-MM a YYYY-MM-01
                        const planData = { ...this.monthlyPlan };
                        if (planData.mes && planData.mes.length === 7) {
                            planData.mes = planData.mes + '-01';
                        }

                        const response = await this.apiCall('/api/monthly/plans', 'POST', planData);

                        if (response) {
                            this.currentPlanId = response.id;
                            this.viewingPlanId = response.id;
                            this.isCreatingNewPlan = false;
                            this.isEditMode = false;

                            this.showNotification('Plan creado exitosamente', 'success');
                            await this.loadMonthlyPlans();
                        }
                    } catch (error) {
                        if (error.message && (error.message.includes('duplicate') || error.message.includes('unique'))) {
                            this.showNotification('Ya existe un plan para este mes', 'error');
                        } else {
                            this.showNotification('Error: ' + error.message, 'error');
                        }
                    }
                },

                checkMonthAvailability() {
                    if (!this.isCreatingNewPlan) return;

                    const existingPlan = this.monthlyPlans.find(p => p.mes === this.monthlyPlan.mes);
                    this.monthAlreadyExists = !!existingPlan;
                },

                addCompetencia() {
                    if (!this.newCompetencia.nombre.trim()) {
                        this.showNotification('Ingresa el nombre de la competencia', 'error');
                        return;
                    }

                    this.monthlyPlan.competencias.push({...this.newCompetencia});

                    // Reset
                    this.newCompetencia = {
                        nombre: '',
                        progreso_inicio: 0,
                        progreso_actual: 0,
                        progreso_fin: null,
                        notas: '',
                        actividades: []
                    };

                    this.showNotification('Competencia agregada', 'success');
                },

                removeCompetencia(index) {
                    this.monthlyPlan.competencias.splice(index, 1);
                    this.showNotification('Competencia eliminada', 'success');
                },

                async updateCompetenciaProgress(index, field, value) {
                    this.monthlyPlan.competencias[index][field] = value;

                    // Guardar autom√°ticamente si el plan ya existe
                    if (this.currentPlanId) {
                        try {
                            await this.apiCall(
                                `/api/monthly/plans/${this.currentPlanId}/competencias`,
                                'PUT',
                                this.monthlyPlan.competencias
                            );
                        } catch (error) {
                            console.error('Error updating competencia:', error);
                        }
                    }
                },

                addActividadToCompetencia(competenciaIndex) {
                    if (!this.newActividad || !this.newActividad.trim()) return;

                    const competencia = this.monthlyPlan.competencias[competenciaIndex];

                    if (!competencia.actividades) {
                        competencia.actividades = [];
                    }

                    competencia.actividades.push({
                        texto: this.newActividad.trim(),
                        completada: false,
                        fecha_creacion: new Date().toISOString().split('T')[0]
                    });

                    this.newActividad = '';

                    // Actualizar progreso basado en actividades
                    this.updateProgressoFromActividades(competenciaIndex);

                    if (this.currentPlanId) {
                        this.saveCompetencias();
                    }
                },

                toggleActividadCompletada(competenciaIndex, actividadIndex) {
                    const actividad = this.monthlyPlan.competencias[competenciaIndex].actividades[actividadIndex];
                    actividad.completada = !actividad.completada;

                    // Actualizar progreso autom√°ticamente basado en actividades completadas
                    this.updateProgressoFromActividades(competenciaIndex);

                    if (this.currentPlanId) {
                        this.saveCompetencias();
                    }
                },

                updateProgressoFromActividades(competenciaIndex) {
                    const competencia = this.monthlyPlan.competencias[competenciaIndex];
                    if (!competencia.actividades || competencia.actividades.length === 0) return;

                    const completadas = competencia.actividades.filter(a => a.completada).length;
                    const total = competencia.actividades.length;
                    const porcentaje = Math.round((completadas / total) * 100);

                    // Actualizar progreso actual basado en las actividades completadas
                    competencia.progreso_actual = porcentaje;
                },

                removeActividad(competenciaIndex, actividadIndex) {
                    this.monthlyPlan.competencias[competenciaIndex].actividades.splice(actividadIndex, 1);

                    // Actualizar progreso basado en actividades
                    this.updateProgressoFromActividades(competenciaIndex);

                    if (this.currentPlanId) {
                        this.saveCompetencias();
                    }
                },

                async saveCompetencias() {
                    if (!this.currentPlanId) return;

                    try {
                        await this.apiCall(
                            `/api/monthly/plans/${this.currentPlanId}/competencias`,
                            'PUT',
                            this.monthlyPlan.competencias
                        );
                        this.showNotification('Competencias actualizadas', 'success');
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                // Actividades del Plan Mensual
                addActividadLograr() {
                    if (!this.newActividadLograr || !this.newActividadLograr.trim()) return;

                    if (!this.monthlyPlan.actividades_lograr) {
                        this.monthlyPlan.actividades_lograr = [];
                    }

                    this.monthlyPlan.actividades_lograr.push({
                        texto: this.newActividadLograr.trim(),
                        completada: false,
                        fecha_creacion: new Date().toISOString().split('T')[0]
                    });

                    this.newActividadLograr = '';
                },

                toggleActividadLograr(index) {
                    const actividad = this.monthlyPlan.actividades_lograr[index];
                    actividad.completada = !actividad.completada;
                },

                removeActividadLograr(index) {
                    this.monthlyPlan.actividades_lograr.splice(index, 1);
                },

                async saveMonthlyReview() {
                    try {
                        // Necesitamos el ID del plan mensual actual
                        const currentPlan = this.stats.currentMonthPlan;
                        if (!currentPlan) {
                            this.showNotification('Debes crear un plan mensual primero', 'warning');
                            return;
                        }

                        const reviewData = {
                            ...this.monthlyReview,
                            monthly_plan_id: currentPlan.id
                        };

                        const response = await this.apiCall('/api/monthly/reviews', 'POST', reviewData);

                        if (response) {
                            this.showNotification('Evaluaci√≥n mensual guardada exitosamente', 'success');

                            // Reset form
                            this.monthlyReview = {
                                que_mejore: '',
                                que_falta_mejorar: '',
                                habilidades_desarrolladas: '',
                                momento_memorable: ''
                            };
                        }
                    } catch (error) {
                        this.showNotification('Error al guardar evaluaci√≥n: ' + error.message, 'error');
                    }
                },

                async saveWeeklyLog() {
                    try {
                        const response = await this.apiCall('/api/weekly/logs', 'POST', this.weeklyLog);

                        if (response) {
                            this.showNotification('Bit√°cora semanal guardada exitosamente', 'success');
                            await this.loadWeeklyLogs();
                            await this.loadDashboardData();

                            // Reset form
                            this.weeklyLog = {
                                semana_inicio: new Date().toISOString().split('T')[0],
                                semana_fin: new Date().toISOString().split('T')[0],
                                logros: [],
                                desafios: [],
                                aprendizajes: '',
                                reflexiones: '',
                                nivel_energia: 3,
                                nivel_satisfaccion: 3
                            };
                            this.newLogro = '';
                            this.newDesafio = '';
                        }
                    } catch (error) {
                        this.showNotification('Error al guardar bit√°cora: ' + error.message, 'error');
                    }
                },

                addLogro() {
                    if (this.newLogro && this.newLogro.trim()) {
                        if (!Array.isArray(this.weeklyLog.logros)) {
                            this.weeklyLog.logros = [];
                        }
                        this.weeklyLog.logros.push(this.newLogro.trim());
                        this.newLogro = '';
                    }
                },

                removeLogro(index) {
                    this.weeklyLog.logros.splice(index, 1);
                },

                addDesafio() {
                    if (this.newDesafio && this.newDesafio.trim()) {
                        if (!Array.isArray(this.weeklyLog.desafios)) {
                            this.weeklyLog.desafios = [];
                        }
                        this.weeklyLog.desafios.push(this.newDesafio.trim());
                        this.newDesafio = '';
                    }
                },

                removeDesafio(index) {
                    this.weeklyLog.desafios.splice(index, 1);
                },

                viewWeeklyLog(log) {
                    this.viewingWeeklyLog = {
                        ...log,
                        logros: Array.isArray(log.logros) ? log.logros : (log.logros ? [log.logros] : []),
                        desafios: Array.isArray(log.desafios) ? log.desafios : (log.desafios ? [log.desafios] : [])
                    };
                    this.showViewWeeklyLogModal = true;
                },

                editWeeklyLog(log) {
                    this.editingWeeklyLog = {
                        ...log,
                        logros: Array.isArray(log.logros) ? log.logros : (log.logros ? [log.logros] : []),
                        desafios: Array.isArray(log.desafios) ? log.desafios : (log.desafios ? [log.desafios] : [])
                    };
                    this.showEditWeeklyLogModal = true;
                },

                async updateWeeklyLog() {
                    try {
                        if (!this.editingWeeklyLog || !this.editingWeeklyLog.id) return;

                        await this.apiCall(`/api/weekly/logs/${this.editingWeeklyLog.id}`, 'PUT', this.editingWeeklyLog);
                        this.showNotification('Bit√°cora actualizada', 'success');
                        await this.loadWeeklyLogs();
                        this.showEditWeeklyLogModal = false;
                        this.editingWeeklyLog = null;
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                addLogroEdit() {
                    if (this.newLogro && this.newLogro.trim()) {
                        if (!Array.isArray(this.editingWeeklyLog.logros)) {
                            this.editingWeeklyLog.logros = [];
                        }
                        this.editingWeeklyLog.logros.push(this.newLogro.trim());
                        this.newLogro = '';
                    }
                },

                removeLogroEdit(index) {
                    this.editingWeeklyLog.logros.splice(index, 1);
                },

                addDesafioEdit() {
                    if (this.newDesafio && this.newDesafio.trim()) {
                        if (!Array.isArray(this.editingWeeklyLog.desafios)) {
                            this.editingWeeklyLog.desafios = [];
                        }
                        this.editingWeeklyLog.desafios.push(this.newDesafio.trim());
                        this.newDesafio = '';
                    }
                },

                removeDesafioEdit(index) {
                    this.editingWeeklyLog.desafios.splice(index, 1);
                },

                // UI Functions
                toggleTheme() {
                    const html = document.documentElement;
                    const currentTheme = html.getAttribute('data-theme');
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                },
                
                showNotification(message, type = 'success') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },
                
                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/login';
                },
                
                async initCharts() {
                    // Esperar a que el DOM est√© completamente renderizado
                    await this.$nextTick();
                    setTimeout(() => {
                        this.renderWeeklyProgressChart();
                        this.renderCategoryChart();
                    }, 100);
                },

                renderWeeklyProgressChart() {
                    const canvas = document.getElementById('weeklyChart');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Destroy existing chart
                    if (this.weeklyChart) {
                        this.weeklyChart.destroy();
                    }

                    // Datos de ejemplo (√∫ltimas 7 semanas)
                    const labels = [];
                    const completedData = [];
                    const createdData = [];

                    for (let i = 6; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - (i * 7));
                        labels.push(`Sem ${d.getDate()}/${d.getMonth() + 1}`);
                        // Simular datos por ahora
                        completedData.push(Math.floor(Math.random() * 5) + 2);
                        createdData.push(Math.floor(Math.random() * 7) + 3);
                    }

                    this.weeklyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Completadas',
                                    data: completedData,
                                    borderColor: 'rgb(34, 197, 94)',
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                },
                                {
                                    label: 'Creadas',
                                    data: createdData,
                                    borderColor: 'rgb(99, 102, 241)',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                },

                renderCategoryChart() {
                    const canvas = document.getElementById('categoryChart');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Destroy existing chart
                    if (this.categoryChart) {
                        this.categoryChart.destroy();
                    }

                    // Contar tareas por categor√≠a
                    const categoryCount = {};
                    this.tasks.forEach(task => {
                        const cat = task.categoria || 'Sin categor√≠a';
                        categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                    });

                    const labels = Object.keys(categoryCount);
                    const data = Object.values(categoryCount);

                    const colors = [
                        'rgb(99, 102, 241)',
                        'rgb(34, 197, 94)',
                        'rgb(251, 191, 36)',
                        'rgb(236, 72, 153)',
                        'rgb(59, 130, 246)',
                        'rgb(139, 92, 246)'
                    ];

                    this.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors.slice(0, labels.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${context.label}: ${value} tareas (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                renderCompetenciasChart() {
                    if (!this.planComparison || !this.planComparison.competencias_stats.competencias.length) return;

                    const canvas = document.getElementById('competenciasChart');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Destroy existing chart
                    if (this.competenciasChart) {
                        this.competenciasChart.destroy();
                    }

                    const competencias = this.planComparison.competencias_stats.competencias;

                    this.competenciasChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: competencias.map(c => c.nombre),
                            datasets: [
                                {
                                    label: 'Progreso Inicio',
                                    data: competencias.map(c => c.progreso_inicio || 0),
                                    backgroundColor: 'rgba(99, 102, 241, 0.5)',
                                    borderColor: 'rgb(99, 102, 241)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Progreso Actual',
                                    data: competencias.map(c => c.progreso_actual || 0),
                                    backgroundColor: 'rgba(34, 197, 94, 0.5)',
                                    borderColor: 'rgb(34, 197, 94)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Progreso Fin',
                                    data: competencias.map(c => c.progreso_fin || 0),
                                    backgroundColor: 'rgba(139, 92, 246, 0.5)',
                                    borderColor: 'rgb(139, 92, 246)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Comparaci√≥n de Progreso por Competencia'
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                },

                renderEvolutionChart() {
                    if (!this.competenciasEvolution || Object.keys(this.competenciasEvolution).length === 0) return;

                    const canvas = document.getElementById('evolutionChart');
                    if (!canvas) return;

                    const ctx = canvas.getContext('2d');

                    // Destroy existing chart
                    if (this.evolutionChart) {
                        this.evolutionChart.destroy();
                    }

                    // Preparar datos
                    const colors = [
                        'rgb(99, 102, 241)',
                        'rgb(34, 197, 94)',
                        'rgb(139, 92, 246)',
                        'rgb(236, 72, 153)',
                        'rgb(251, 191, 36)',
                        'rgb(59, 130, 246)'
                    ];

                    const datasets = Object.keys(this.competenciasEvolution).map((competencia, index) => {
                        const data = this.competenciasEvolution[competencia];
                        return {
                            label: competencia,
                            data: data.map(d => ({
                                x: d.mes,
                                y: d.progreso_fin || d.progreso_actual
                            })),
                            borderColor: colors[index % colors.length],
                            backgroundColor: colors[index % colors.length].replace(')', ', 0.1)').replace('rgb', 'rgba'),
                            tension: 0.4,
                            fill: false
                        };
                    });

                    this.evolutionChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'month',
                                        displayFormats: {
                                            month: 'MMM yyyy'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Mes'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Progreso'
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Evoluci√≥n de Competencias (√öltimos 6 Meses)'
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                }
                            }
                        }
                    });
                },

                // Financial Methods
                async loadFinancialCategories() {
                    try {
                        const response = await this.apiCall('/api/financial/categories');
                        if (response) {
                            this.financialCategories = response;
                        }
                        if (response && response.length === 0) {
                            await this.apiCall('/api/financial/initialize', 'POST');
                            await this.loadFinancialCategories();
                        }
                    } catch (error) {
                        console.error('Error loading categories:', error);
                    }
                },

                async loadFinancialRecords(mes = null) {
                    try {
                        const queryMes = mes || this.selectedMonth + '-01';
                        const response = await this.apiCall(`/api/financial/records?mes=${queryMes}`);
                        if (response) {
                            this.financialRecords = response;
                        }
                    } catch (error) {
                        console.error('Error loading records:', error);
                    }
                },

                async loadFinancialSummary(mes = null) {
                    try {
                        const queryMes = mes || this.selectedMonth + '-01';
                        const response = await this.apiCall(`/api/financial/summary?mes=${queryMes}`);
                        if (response) {
                            this.financialSummary = response;
                            this.updateExpensesChart();
                        }
                    } catch (error) {
                        console.error('Error loading summary:', error);
                    }
                },

                async saveFinancialRecord() {
                    if (!this.newFinancialRecord.monto || this.newFinancialRecord.monto <= 0) {
                        this.showNotification('Ingresa un monto v√°lido', 'error');
                        return;
                    }
                    if (!this.newFinancialRecord.category_id) {
                        this.showNotification('Selecciona una categor√≠a', 'error');
                        return;
                    }

                    try {
                        this.newFinancialRecord.mes = this.selectedMonth + '-01';
                        await this.apiCall('/api/financial/records', 'POST', this.newFinancialRecord);
                        this.showNotification('Registro guardado', 'success');
                        await this.loadFinancialRecords();
                        await this.loadFinancialSummary();

                        // Reset form
                        this.newFinancialRecord = {
                            mes: this.selectedMonth + '-01',
                            fecha_transaccion: new Date().toISOString().split('T')[0],
                            tipo: 'gasto',
                            monto: 0,
                            descripcion: '',
                            category_id: ''
                        };
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async deleteFinancialRecord(recordId) {
                    if (!confirm('¬øEliminar este registro?')) return;
                    try {
                        await this.apiCall(`/api/financial/records/${recordId}`, 'DELETE');
                        this.showNotification('Registro eliminado', 'success');
                        await this.loadFinancialRecords();
                        await this.loadFinancialSummary();
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async saveFinancialCategory() {
                    if (!this.newFinancialCategory.nombre.trim()) {
                        this.showNotification('Ingresa un nombre', 'error');
                        return;
                    }
                    try {
                        await this.apiCall('/api/financial/categories', 'POST', this.newFinancialCategory);
                        this.showNotification('Categor√≠a creada', 'success');
                        await this.loadFinancialCategories();
                        this.newFinancialCategory = {
                            nombre: '',
                            tipo: 'gasto',
                            color: '#6366f1',
                            icono: ''
                        };
                    } catch (error) {
                        this.showNotification('Error: ' + error.message, 'error');
                    }
                },

                async changeFinancialMonth() {
                    await this.loadFinancialRecords();
                    await this.loadFinancialSummary();
                },

                updateExpensesChart() {
                    if (!this.financialSummary) return;

                    const ctx = document.getElementById('expensesChart');
                    if (!ctx) return;

                    if (this.expensesChart) {
                        this.expensesChart.destroy();
                    }

                    const gastos = this.financialSummary.gastos_por_categoria || [];
                    if (gastos.length === 0) return;

                    const colors = gastos.map(g => {
                        const cat = this.financialCategories.find(c => c.nombre === g.categoria);
                        return cat ? cat.color : '#6366f1';
                    });

                    this.expensesChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: gastos.map(g => g.categoria),
                            datasets: [{
                                data: gastos.map(g => g.monto),
                                backgroundColor: colors,
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                formatCurrency(amount) {
                    return new Intl.NumberFormat('es-MX', {
                        style: 'currency',
                        currency: 'MXN'
                    }).format(amount || 0);
                },

                // Filtros de tareas
                get filteredTasks() {
                    let filtered = this.tasks;

                    // Filtrar por estado
                    if (this.filterEstado) {
                        filtered = filtered.filter(t => t.estado === this.filterEstado);
                    }

                    // Filtrar por prioridad
                    if (this.filterPrioridad) {
                        filtered = filtered.filter(t => t.prioridad === this.filterPrioridad);
                    }

                    // Filtrar por clasificaci√≥n
                    if (this.filterClasificacion) {
                        filtered = filtered.filter(t => t.clasificacion === this.filterClasificacion);
                    }

                    // Filtrar por fecha (fecha_inicio o fecha_fin coincide con la fecha seleccionada)
                    if (this.filterFecha) {
                        filtered = filtered.filter(t => {
                            const fechaInicio = t.fecha_inicio ? t.fecha_inicio.split('T')[0] : null;
                            const fechaFin = t.fecha_fin ? t.fecha_fin.split('T')[0] : null;
                            return fechaInicio === this.filterFecha || fechaFin === this.filterFecha ||
                                   (fechaInicio <= this.filterFecha && fechaFin >= this.filterFecha);
                        });
                    }

                    return filtered;
                },

                get uniqueClasificaciones() {
                    const clasificaciones = new Set();
                    this.tasks.forEach(task => {
                        if (task.clasificacion) {
                            clasificaciones.add(task.clasificacion);
                        }
                    });
                    return Array.from(clasificaciones).sort();
                },

                clearFilters() {
                    this.filterEstado = '';
                    this.filterPrioridad = '';
                    this.filterClasificacion = '';
                    this.filterFecha = '';
                }
            }
        }
    </script>
</body>
</html>
